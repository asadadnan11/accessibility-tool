<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Enhanced Learning Accessibility Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            transition: all 0.3s ease;
        }

        /* Multiple Color Themes */
        body.theme-yellow-black {
            background: #000;
            color: #ffff00;
        }

        body.theme-blue-white {
            background: #000080;
            color: #ffffff;
        }

        body.theme-blue-white .transcript-section,
        body.theme-blue-white .ai-section,
        body.theme-blue-white .enhanced-controls,
        body.theme-blue-white .mcq-question {
            background: #000080 !important;
            color: #ffffff !important;
        }

        body.theme-blue-white .mcq-question h5,
        body.theme-blue-white .mcq-question p,
        body.theme-blue-white .mcq-question div {
            color: #ffffff !important;
            background: #000080 !important;
        }

        body.theme-green-black {
            background: #000;
            color: #00ff00;
        }

        body.theme-high-contrast {
            background: #000;
            color: #fff;
        }

        /* Focus Mode */
        body.focus-mode {
            background: #1a1a1a;
            color: #ffffff;
        }

        body.focus-mode .controls,
        body.focus-mode .sidebar {
            display: none !important;
        }

        /* Keep header visible in focus mode but style it properly */
        body.focus-mode .header {
            background: #1a1a1a !important;
            color: #ffffff !important;
        }

        body.focus-mode .header h1,
        body.focus-mode .header p {
            color: #ffffff !important;
        }

        body.focus-mode .main-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Focus mode text visibility fixes */
        body.focus-mode .transcript-content,
        body.focus-mode .mcq-question,
        body.focus-mode .mcq-question h5,
        body.focus-mode .mcq-question p,
        body.focus-mode .mcq-question div,
        body.focus-mode .mcq-question span {
            color: #ffffff !important;
            background: #1a1a1a !important;
        }

        body.focus-mode .transcript-section,
        body.focus-mode .ai-section {
            background: #1a1a1a !important;
            color: #ffffff !important;
        }

        body.focus-mode .mcq-option {
            background: #333333 !important;
            color: #ffffff !important;
            border-color: #ffffff !important;
        }

        body.focus-mode .mcq-option:hover {
            background: #444444 !important;
            color: #ffffff !important;
        }

        body.focus-mode .mcq-option.selected {
            background: #555555 !important;
            color: #ffffff !important;
        }

        body.focus-mode .mcq-option.correct {
            background: #006400 !important;
            color: #ffffff !important;
        }

        body.focus-mode .mcq-option.incorrect {
            background: #8b0000 !important;
            color: #ffffff !important;
        }

        /* Reading Guide */
        .reading-guide {
            position: fixed;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 0, 0.3);
            z-index: 1000;
            pointer-events: none;
            transition: top 0.3s ease;
            display: block;
        }

        .reading-guide.active {
            background: rgba(255, 255, 0, 0.8);
        }

        /* Progress Tracking */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: #4CAF50;
            z-index: 1001;
            transition: width 0.3s ease;
        }

        .session-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1002;
        }

        /* Enhanced Controls */
        .enhanced-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .control-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #007bff;
            color: white;
        }

        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #6c757d;
        }

        button.success {
            background: #28a745;
        }

        button.warning {
            background: #ffc107;
            color: #212529;
        }

        button.danger {
            background: #dc3545;
        }

        /* Main Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .transcript-section, .ai-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .transcript-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            line-height: 1.8;
            font-size: 16px;
        }

        /* Step Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .step-indicator {
            font-weight: bold;
            color: #007bff;
        }

        /* Enhanced TTS Controls */
        .tts-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .voice-selector {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Interactive Elements */
        .flashcard {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .flashcard:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }

        .flashcard.flipped {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .mcq-question {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .mcq-option {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }

        .mcq-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
            color: #333;
        }

        .mcq-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
            color: #333;
        }

        .mcq-option.correct {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .mcq-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .mcq-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .mcq-feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .mcq-feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Notes Section */
        .notes-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }

        /* Achievement System */
        .achievements {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            max-width: 300px;
            z-index: 1003;
        }

        .achievement {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .achievement-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .step-navigation {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* High Contrast Theme Enhancements */
        body.high-contrast .transcript-content,
        body.high-contrast .flashcard,
        body.high-contrast .mcq-question,
        body.high-contrast .mcq-option,
        body.high-contrast .enhanced-controls,
        body.high-contrast .transcript-section,
        body.high-contrast .ai-section {
            background: #111;
            color: #fff;
            border-color: #fff;
        }

        body.high-contrast .mcq-option:hover {
            background: #333;
            border-color: #fff;
        }

        body.high-contrast .mcq-option.selected {
            background: #444;
            border-color: #fff;
        }

        body.high-contrast .mcq-option.correct {
            background: #006400;
            border-color: #00ff00;
            color: #fff;
        }

        body.high-contrast .mcq-option.incorrect {
            background: #8b0000;
            border-color: #ff0000;
            color: #fff;
        }

        body.high-contrast .mcq-feedback {
            background: #111;
            border-color: #fff;
            color: #fff;
        }

        body.high-contrast .mcq-feedback.correct {
            background: #006400;
            border-color: #00ff00;
            color: #fff;
        }

        body.high-contrast .mcq-feedback.incorrect {
            background: #8b0000;
            border-color: #ff0000;
            color: #fff;
        }

        body.high-contrast .flashcard.flipped {
            background: #333;
            color: #fff;
        }

        body.high-contrast .step-navigation {
            background: #333;
            color: #fff;
        }

        body.high-contrast .notes-section {
            background: #333;
            border-color: #fff;
            color: #fff;
        }

        body.high-contrast .achievements {
            background: #111;
            color: #fff;
        }

        body.high-contrast .achievement {
            background: #333;
            color: #fff;
        }

        /* Fix for question text visibility in high contrast */
        body.high-contrast .mcq-question h5 {
            color: #fff !important;
            background: #111 !important;
        }

        body.high-contrast .mcq-question p {
            color: #fff !important;
            background: #111 !important;
        }

        body.high-contrast .mcq-question div {
            color: #fff !important;
            background: #111 !important;
        }

        /* Force all text to be white in high contrast */
        body.high-contrast * {
            color: #fff !important;
        }

        /* Override any theme colors in high contrast */
        body.high-contrast.theme-yellow-black *,
        body.high-contrast.theme-blue-white *,
        body.high-contrast.theme-green-black * {
            color: #fff !important;
        }

        /* Specific overrides for question elements */
        body.high-contrast .mcq-question,
        body.high-contrast .mcq-question *,
        body.high-contrast .mcq-question h5,
        body.high-contrast .mcq-question p,
        body.high-contrast .mcq-question span,
        body.high-contrast .mcq-question div {
            color: #fff !important;
            background: #111 !important;
        }

        /* Ensure all headings are white */
        body.high-contrast h1,
        body.high-contrast h2,
        body.high-contrast h3,
        body.high-contrast h4,
        body.high-contrast h5,
        body.high-contrast h6 {
            color: #fff !important;
        }

        /* Ensure all text elements are white */
        body.high-contrast p,
        body.high-contrast span,
        body.high-contrast div,
        body.high-contrast label {
            color: #fff !important;
        }

        /* Ensure header is always visible in all themes */
        body.high-contrast .header,
        body.theme-yellow-black .header,
        body.theme-blue-white .header,
        body.theme-green-black .header,
        body.focus-mode .header {
            display: block !important;
            visibility: visible !important;
        }

        body.high-contrast .header h1,
        body.high-contrast .header p,
        body.theme-yellow-black .header h1,
        body.theme-yellow-black .header p,
        body.theme-blue-white .header h1,
        body.theme-blue-white .header p,
        body.theme-green-black .header h1,
        body.theme-green-black .header p,
        body.focus-mode .header h1,
        body.focus-mode .header p {
            color: inherit !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <!-- Progress Bar -->
    <div class="progress-bar" id="progressBar"></div>
    
    <!-- Session Info -->
    <div class="session-info" id="sessionInfo">
        <div>Session: <span id="sessionTime">00:00</span></div>
        <div>Progress: <span id="progressPercent">0%</span></div>
    </div>

    <!-- Reading Guide -->
    <div class="reading-guide" id="readingGuide"></div>

    <div class="container">
        <div class="header">
            <h1>AI-Enhanced Learning Accessibility Tool</h1>
            <p>Optimized for Neurodivergent and ESL Students</p>
        </div>
        
        <!-- Status Message -->
        <div id="statusMessage" style="margin: 20px 0; padding: 15px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 10px 0; color: #0056b3;">🚀 Ready to Use!</h4>
            <p style="margin: 0; color: #0056b3;">
                <strong>Default transcript loaded.</strong> To use AI features: 
                <br>1. Enter your OpenAI API key below 
                <br>2. Click "Generate Flashcards", "Generate Quiz", etc.
                <br>3. Or upload your own audio/video file for transcription
            </p>
            <p style="margin-top: 10px; font-weight: bold; color: #d63384;">💡 Click the "🔧 Test All Features" button (top-right) to diagnose any issues!</p>
        </div>

        <!-- Enhanced Controls -->
        <div class="enhanced-controls">
            <div class="control-group">
                <h4>🎯 Focus & Navigation</h4>
                <div class="control-buttons">
                    <button onclick="toggleFocusMode()" id="focusBtn">Focus Mode</button>
                    <button onclick="toggleReadingGuide()" id="guideBtn">Reading Guide</button>
                    <button onclick="resetProgress()">Reset Progress</button>
                    <button onclick="fullscreenMode()">Fullscreen</button>
                </div>
            </div>

            <div class="control-group">
                <h4>🎨 Visual Accessibility</h4>
                <div class="control-buttons">
                    <button onclick="changeTheme('default')">Default</button>
                    <button onclick="changeTheme('yellow-black')">Yellow/Black</button>
                    <button onclick="changeTheme('blue-white')">Blue/White</button>
                    <button onclick="changeTheme('green-black')">Green/Black</button>
                    <button onclick="changeTheme('high-contrast')">High Contrast</button>
                </div>
                <div style="margin-top: 10px;">
                    <label>Font Size: </label>
                    <button onclick="changeFontSize(14)">Small</button>
                    <button onclick="changeFontSize(16)">Medium</button>
                    <button onclick="changeFontSize(18)">Large</button>
                    <button onclick="changeFontSize(20)">Extra Large</button>
                </div>
                <div style="margin-top: 10px;">
                    <label>Line Spacing: </label>
                    <button onclick="changeLineSpacing('1.2')">Tight</button>
                    <button onclick="changeLineSpacing('1.6')">Normal</button>
                    <button onclick="changeLineSpacing('2.0')">Loose</button>
                    <button onclick="changeLineSpacing('2.5')">Very Loose</button>
                </div>
            </div>

            <div class="control-group">
                <h4>🔊 Enhanced Text-to-Speech</h4>
                <div class="tts-controls">
                    <button onclick="toggleReadAloud()" id="readAloudBtn">Read Aloud</button>
                    <button onclick="stopReading()">Stop</button>
                    <button onclick="pauseReading()">Pause</button>
                    <button onclick="resumeReading()">Resume</button>
                    <select id="voiceSelect" class="voice-selector">
                        <option value="">Select Voice</option>
                    </select>
                    <select id="speedSelect" class="voice-selector">
                        <option value="0.5">Very Slow</option>
                        <option value="0.8">Slow</option>
                        <option value="1.0" selected>Normal</option>
                        <option value="1.2">Fast</option>
                        <option value="1.5">Very Fast</option>
                    </select>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="translateToSpanish()">Translate to Spanish</button>
                    <button onclick="translateToFrench()">Translate to French</button>
                    <button onclick="translateToGerman()">Translate to German</button>
                    <button onclick="resetTranslation()">Reset to English</button>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                    <h5>🎤 Voice Input & Translation</h5>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Speak to translate your voice to text in different languages</p>
                    <button onclick="startVoiceInput()" id="voiceInputBtn" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Start Voice Input</button>
                    <button onclick="stopVoiceInput()" id="stopVoiceBtn" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; display: none;">Stop Voice Input</button>
                    <select id="voiceLanguageSelect" style="margin-left: 10px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="en-US">English</option>
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                    </select>
                    <div id="voiceStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
            </div>

            <div class="control-group">
                <h4>📚 Learning Tools</h4>
                <div class="control-buttons">
                    <button onclick="generateFlashcards()">Generate Flashcards</button>
                    <button onclick="generateQuiz()">Generate Quiz</button>
                    <button onclick="generateSummary()">Generate Summary</button>
                    <button onclick="generateStudyGuide()">Generate Study Guide</button>
                    <button onclick="toggleNotes()" id="notesBtn">Show Notes</button>
                </div>
            </div>
        </div>

        <!-- Step Navigation -->
        <div class="step-navigation">
            <button onclick="previousSection()" id="prevBtn">← Previous</button>
            <div class="step-indicator">Section <span id="currentSection">1</span> of <span id="totalSections">1</span></div>
            <button onclick="nextSection()" id="nextBtn">Next →</button>
        </div>

        <div class="main-content">
            <!-- Video and Transcript Input Section -->
            <div class="transcript-input-section" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #007bff;">
                <h3>Add Video or Transcript</h3>
                
                <!-- Video Input Tabs -->
                                   <div style="margin-bottom: 20px;">
                       <button id="videoTab" onclick="showVideoInput()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Audio/Video Upload</button>
                       <button id="transcriptTab" onclick="showTranscriptInput()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Manual Transcript</button>
                   </div>

                <!-- Video Input Section -->
                <div id="videoInputSection" style="display: block;">
                                           <div style="margin-bottom: 15px;">
                           <h4>Upload Audio/Video File</h4>
                           <input type="file" id="videoFile" accept="audio/*,video/*" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                           <p style="font-size: 12px; color: #666; margin-top: 5px;">Audio files (MP3, WAV, etc.) work best. Video files may have limited support.</p>
                           <button onclick="processVideoFile()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Process File</button>
                       </div>
                    
                    <div style="margin-bottom: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
                        <h4>Or Enter Video URL</h4>
                        <input type="url" id="videoUrl" placeholder="Enter video URL (YouTube, Vimeo, etc.)" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                        <button onclick="processVideoUrl()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Process Video URL</button>
                    </div>
                    
                    <div id="processingStatus" style="display: none; margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
                        <p id="statusText">Processing video...</p>
                        <div id="progressBar" style="width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden;">
                            <div id="progressFill" style="width: 0%; height: 100%; background: #007bff; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <!-- Manual Transcript Input Section -->
                <div id="transcriptInputSection" style="display: block;">
                    <h4>📝 Add Your Transcript</h4>
                    <p style="margin-bottom: 15px; color: #666;">Paste your lecture transcript below to generate AI-powered study materials. If you don't have a transcript, you can use the default FOIL method example.</p>
                    <textarea 
                        id="transcriptInput" 
                        placeholder="Paste your lecture transcript here...&#10;&#10;Example:&#10;Today we'll be discussing the FOIL method for multiplying binomials. FOIL stands for First, Outer, Inner, Last..." 
                        style="width: 100%; height: 150px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"
                    ></textarea>
                                            <div style="margin-top: 15px;">
                            <button onclick="loadCustomTranscript()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Load Transcript</button>
                            <button onclick="loadDefaultTranscript()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Use Default (FOIL Method)</button>
                            <button onclick="debugTranscript()" style="background: #ffc107; color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Debug Transcript</button>
                            <button onclick="clearAllAIContent()" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Clear AI Content</button>
                            <button onclick="testAPIConnection()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Test API</button>
                        </div>
                    <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 5px;">
                        <strong>💡 Tip:</strong> After loading your transcript, enter your OpenAI API key below and click the AI generation buttons to create flashcards, quizzes, summaries, and study guides.
                    </div>
                </div>
            </div>

            <div class="transcript-section">
                <h3>Lecture Transcript</h3>
                <div id="transcriptStatus" style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; display: none;">
                    <span style="color: #856404;">📄 Transcript loaded and ready for AI generation</span>
                </div>
                <div class="transcript-content" id="transcriptContent" style="padding: 20px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; min-height: 100px; display: flex; align-items: center; justify-content: center; text-align: center; color: #6c757d;">
                    <div>
                        <h4>📝 No Transcript Loaded</h4>
                        <p>Please add your transcript using the input section above, or click "Use Default (FOIL Method)" to load the example transcript.</p>
                        <p style="font-size: 14px; margin-top: 10px;">Once you load a transcript, you can generate AI-powered study materials!</p>
                    </div>
                </div>
            </div>

            <div class="ai-section">
                <h3>AI Learning Assistant</h3>
                
                <!-- API Key Section -->
                <div class="api-key-section" style="margin-bottom: 20px;">
                    <label for="apiKey">OpenAI API Key:</label>
                    <input type="password" id="apiKey" placeholder="Enter your OpenAI API key" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <!-- Interactive Flashcards -->
                <div id="flashcardsContainer" style="display: none;">
                    <h4>Interactive Flashcards</h4>
                    <div id="flashcardDisplay"></div>
                    <div style="margin-top: 10px;">
                        <button onclick="previousCard()" id="prevCardBtn">← Previous</button>
                        <span id="cardCounter" style="margin: 0 10px;">Card 1 of 1</span>
                        <button onclick="nextCard()" id="nextCardBtn">Next →</button>
                    </div>
                </div>

                <!-- Interactive Quiz -->
                <div id="quizContainer" style="display: none;">
                    <h4>Interactive Quiz</h4>
                    <div id="quizDisplay"></div>
                    <div style="margin-top: 10px;">
                        <button onclick="previousQuestion()" id="prevQuestionBtn">← Previous</button>
                        <span id="questionCounter" style="margin: 0 10px;">Question 1 of 1</span>
                        <button onclick="nextQuestion()" id="nextQuestionBtn">Next →</button>
                    </div>
                </div>

                <!-- Study Materials -->
                <div id="studyMaterials" style="display: none;">
                    <h4>Study Materials</h4>
                    <div id="materialsContent"></div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section" id="notesSection" style="display: none;">
            <h4>📝 Personal Notes</h4>
            <textarea class="notes-textarea" id="notesTextarea" placeholder="Take your personal notes here..."></textarea>
            <div style="margin-top: 10px;">
                <button onclick="saveNotes()">Save Notes</button>
                <button onclick="clearNotes()">Clear Notes</button>
            </div>
        </div>
    </div>

    <!-- Achievements -->
    <div class="achievements" id="achievements" style="display: none;">
        <h4>🏆 Achievements</h4>
        <div id="achievementsList"></div>
    </div>

    <script>
        // Global variables
        let isReading = false;
        let currentUtterance = null;
        let isPaused = false;
        let sessionStartTime = Date.now();
        let currentCardIndex = 0;
        let currentQuestionIndex = 0;
        let flashcards = [];
        let quizQuestions = [];
        let sections = [];
        let currentSectionIndex = 0;
        let isFocusMode = false;
        let isReadingGuideActive = false;
        let achievements = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing application...');
            
            // Test flashcard parsing logic
            testFlashcardParsing();
            
            // Add debug function to window for testing
            window.debugTranscript = function() {
                const transcript = document.getElementById('transcriptContent');
                const content = transcript.textContent;
                console.log('=== CURRENT TRANSCRIPT DEBUG ===');
                console.log('Length:', content.length);
                console.log('Content:', content);
                console.log('Contains FOIL:', content.includes('FOIL'));
                console.log('Original stored:', window.originalTranscriptContent);
                
                // Show a more user-friendly alert with key info
                const preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
                alert(`Transcript Debug Info:\n\nLength: ${content.length} characters\nContains FOIL: ${content.includes('FOIL')}\n\nPreview: ${preview}\n\nCheck console (F12) for full content.`);
            };
            
            // Add function to clear all AI content and start fresh
            window.clearAllAIContent = function() {
                console.log('=== CLEARING ALL AI CONTENT ===');
                
                // Clear flashcards
                const flashcardDisplay = document.getElementById('flashcardDisplay');
                if (flashcardDisplay) {
                    flashcardDisplay.innerHTML = '';
                }
                
                // Clear quiz
                const quizDisplay = document.getElementById('quizDisplay');
                if (quizDisplay) {
                    quizDisplay.innerHTML = '';
                }
                
                // Clear study materials
                const studyMaterials = document.getElementById('studyMaterials');
                if (studyMaterials) {
                    studyMaterials.innerHTML = '';
                }
                
                // Reset flashcard state
                if (typeof resetFlashcardState === 'function') {
                    resetFlashcardState();
                }
                
                console.log('All AI content cleared');
                alert('All AI-generated content has been cleared. You can now generate fresh content.');
            };
            
            // Add function to test API connection with a simple request
            window.testAPIConnection = async function() {
                console.log('=== TESTING API CONNECTION ===');
                
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    alert('Please enter your OpenAI API key first.');
                    return;
                }
                
                try {
                    console.log('Making test API request...');
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{
                                role: 'user',
                                content: 'Say "Hello, API is working!"'
                            }],
                            max_tokens: 50,
                            temperature: 0.7
                        })
                    });
                    
                    console.log('Test API response status:', response.status);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Test API Error:', errorData);
                        throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Test API response:', data);
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        alert(`API Test Successful!\n\nResponse: ${data.choices[0].message.content}`);
                    } else {
                        throw new Error('Invalid response format from API');
                    }
                    
                } catch (error) {
                    console.error('API Test Error:', error);
                    alert(`API Test Failed: ${error.message}`);
                }
            };
            
            // Verify critical elements exist FIRST
            const criticalElements = [
                'flashcardsContainer',
                'flashcardDisplay',
                'cardCounter',
                'quizContainer',
                'studyMaterials',
                'transcriptContent'
            ];
            
            console.log('=== CRITICAL ELEMENTS CHECK ===');
            criticalElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}:`, element ? 'Found' : 'MISSING!');
                if (element) {
                    console.log(`  - ${id} tagName:`, element.tagName);
                    console.log(`  - ${id} id:`, element.id);
                    console.log(`  - ${id} display:`, window.getComputedStyle(element).display);
                }
            });
            
            // Also check if document.body exists
            console.log('document.body exists:', !!document.body);
            console.log('document.documentElement exists:', !!document.documentElement);
            
            initializeVoices();
            loadProgress();
            updateSessionInfo();
            setInterval(updateSessionInfo, 1000);
            chunkContentIntoSections();
            updateProgress();
        });

        // Initialize speech synthesis voices
        function initializeVoices() {
            const voiceSelect = document.getElementById('voiceSelect');
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = function() {
                    const voices = speechSynthesis.getVoices();
                    voiceSelect.innerHTML = '<option value="">Select Voice</option>';
                    
                    // Add default options for common languages
                    const defaultOptions = [
                        { name: 'English (US)', lang: 'en-US' },
                        { name: 'English (UK)', lang: 'en-GB' },
                        { name: 'Spanish', lang: 'es-ES' },
                        { name: 'French', lang: 'fr-FR' },
                        { name: 'German', lang: 'de-DE' },
                        { name: 'Chinese', lang: 'zh-CN' },
                        { name: 'Japanese', lang: 'ja-JP' },
                        { name: 'Korean', lang: 'ko-KR' }
                    ];
                    
                    // Add default options first
                    defaultOptions.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.lang;
                        opt.textContent = option.name;
                        voiceSelect.appendChild(opt);
                    });
                    
                    // Add available browser voices
                    voices.forEach((voice, index) => {
                        const option = document.createElement('option');
                        option.value = `voice_${index}`;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        voiceSelect.appendChild(option);
                    });
                };
            }
        }

        // Focus Mode
        function toggleFocusMode() {
            const body = document.body;
            const btn = document.getElementById('focusBtn');
            
            if (isFocusMode) {
                body.classList.remove('focus-mode');
                btn.textContent = 'Focus Mode';
                isFocusMode = false;
                resetToDefaultStyles();
            } else {
                body.classList.add('focus-mode');
                btn.textContent = 'Exit Focus';
                isFocusMode = true;
                forceFocusModeStyles();
            }
        }

        function forceFocusModeStyles() {
            console.log('Applying focus mode styles...');
            
            // Force all text elements to be white
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('background-color', '#1a1a1a', 'important');
            });
            
            // Force all backgrounds to be dark
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#1a1a1a', 'important');
            });
            
            // Force MCQ options to be visible
            const optionElements = document.querySelectorAll('.mcq-option');
            optionElements.forEach(element => {
                element.style.setProperty('background-color', '#333333', 'important');
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('border-color', '#ffffff', 'important');
            });
            
            // Ensure header is visible in focus mode
            const header = document.querySelector('.header');
            if (header) {
                header.style.setProperty('display', 'block', 'important');
                header.style.setProperty('visibility', 'visible', 'important');
                header.style.setProperty('background-color', '#1a1a1a', 'important');
                header.style.setProperty('color', '#ffffff', 'important');
            }
            
            console.log('Focus mode styles applied');
        }

        // Reading Guide
        function toggleReadingGuide() {
            console.log('=== TOGGLING READING GUIDE ===');
            const guide = document.getElementById('readingGuide');
            const btn = document.getElementById('guideBtn');
            
            console.log('Reading guide element:', guide);
            console.log('Guide button:', btn);
            console.log('Current reading guide state:', isReadingGuideActive);
            
            if (isReadingGuideActive) {
                guide.style.display = 'none';
                btn.textContent = 'Reading Guide';
                isReadingGuideActive = false;
                console.log('Reading guide hidden');
            } else {
                guide.style.display = 'block';
                btn.textContent = 'Hide Guide';
                isReadingGuideActive = true;
                updateReadingGuidePosition();
                console.log('Reading guide shown');
            }
        }

        function updateReadingGuidePosition() {
            if (!isReadingGuideActive) return;
            
            const transcript = document.getElementById('transcriptContent');
            const guide = document.getElementById('readingGuide');
            
            if (!transcript || !guide) {
                console.log('Transcript or guide element not found');
                return;
            }
            
            const scrollTop = transcript.scrollTop;
            const scrollHeight = transcript.scrollHeight;
            const clientHeight = transcript.clientHeight;
            
            console.log('Scroll position - top:', scrollTop, 'height:', scrollHeight, 'client:', clientHeight);
            
            if (scrollHeight <= clientHeight) {
                guide.style.top = '20%';
                console.log('Content fits in view, guide positioned at 20%');
                return;
            }
            
            const progress = scrollTop / (scrollHeight - clientHeight);
            const position = 20 + (progress * 60); // 20% to 80% of viewport
            
            guide.style.top = position + '%';
            console.log('Guide positioned at:', position + '%');
        }

        // Enhanced Text-to-Speech
        function toggleReadAloud() {
            const button = document.getElementById('readAloudBtn');
            if (isReading) {
                stopReading();
                isReading = false;
                button.textContent = 'Read Aloud';
            } else {
                readTranscript();
                isReading = true;
                button.textContent = 'Stop Reading';
            }
        }

        function readTranscript() {
            if ('speechSynthesis' in window) {
                const transcript = document.getElementById('transcriptContent').textContent;
                const voiceSelect = document.getElementById('voiceSelect');
                const speedSelect = document.getElementById('speedSelect');
                
                console.log('Text-to-speech: Transcript length:', transcript.length);
                console.log('Text-to-speech: Transcript preview:', transcript.substring(0, 100));
                
                if (!transcript || transcript.trim().length === 0) {
                    alert('No transcript content available. Please load a transcript first.');
                    return;
                }
                
                currentUtterance = new SpeechSynthesisUtterance(transcript);
                currentUtterance.rate = parseFloat(speedSelect.value);
                currentUtterance.pitch = 1.0;
                
                if (voiceSelect.value !== '') {
                    if (voiceSelect.value.startsWith('voice_')) {
                        // Browser voice
                        const voices = speechSynthesis.getVoices();
                        const voiceIndex = parseInt(voiceSelect.value.replace('voice_', ''));
                        currentUtterance.voice = voices[voiceIndex];
                    } else {
                        // Language code
                        currentUtterance.lang = voiceSelect.value;
                    }
                }
                
                currentUtterance.onend = () => {
                    isReading = false;
                    document.getElementById('readAloudBtn').textContent = 'Read Aloud';
                };
                
                speechSynthesis.speak(currentUtterance);
                isReading = true;
            }
        }

        function stopReading() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                isReading = false;
                currentUtterance = null;
            }
        }

        function pauseReading() {
            if ('speechSynthesis' in window && isReading) {
                speechSynthesis.pause();
                isPaused = true;
            }
        }

        function resumeReading() {
            if ('speechSynthesis' in window && isPaused) {
                speechSynthesis.resume();
                isPaused = false;
            }
        }

        // Progress Tracking
        function updateProgress() {
            const transcript = document.getElementById('transcriptContent');
            const scrollTop = transcript.scrollTop;
            const scrollHeight = transcript.scrollHeight;
            const clientHeight = transcript.clientHeight;
            
            // Fix NaN issue by checking for valid values
            let progress = 0;
            
            // Check if there's any content
            if (!transcript.textContent || transcript.textContent.trim().length === 0) {
                progress = 0;
            } else if (scrollHeight > clientHeight && scrollHeight > 0) {
                // Content is scrollable - calculate based on scroll position
                progress = Math.min(100, Math.round((scrollTop / (scrollHeight - clientHeight)) * 100));
            } else if (scrollHeight > 0) {
                // Content fits in view - mark as complete if there's content
                progress = 100;
            }
            
            // Ensure progress is a valid number
            if (isNaN(progress) || progress < 0) {
                progress = 0;
            }
            
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = progress + '%';
            
            // Check for achievements
            checkAchievements(progress);
            
            // Save progress
            localStorage.setItem('learningProgress', progress);
            
            // Debug logging
            console.log('Progress update:', {
                scrollTop,
                scrollHeight,
                clientHeight,
                contentLength: transcript.textContent ? transcript.textContent.length : 0,
                progress
            });
        }

        function updateSessionInfo() {
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sessionTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress on each timer tick to ensure it's current
            updateProgress();
        }

        function resetProgress() {
            localStorage.removeItem('learningProgress');
            document.getElementById('transcriptContent').scrollTop = 0;
            updateProgress();
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem('learningProgress');
            if (savedProgress && !isNaN(parseInt(savedProgress))) {
                const transcript = document.getElementById('transcriptContent');
                const scrollHeight = transcript.scrollHeight;
                const clientHeight = transcript.clientHeight;
                
                // Only restore scroll position if content is scrollable
                if (scrollHeight > clientHeight) {
                    const targetScroll = (parseInt(savedProgress) / 100) * (scrollHeight - clientHeight);
                    transcript.scrollTop = targetScroll;
                }
            }
        }

        // Step Navigation
        function chunkContentIntoSections() {
            const content = document.getElementById('transcriptContent').textContent;
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentencesPerSection = Math.ceil(sentences.length / 5);
            
            sections = [];
            for (let i = 0; i < sentences.length; i += sentencesPerSection) {
                sections.push(sentences.slice(i, i + sentencesPerSection).join('. ') + '.');
            }
            
            document.getElementById('totalSections').textContent = sections.length;
            updateSectionDisplay();
        }

        function nextSection() {
            if (currentSectionIndex < sections.length - 1) {
                currentSectionIndex++;
                updateSectionDisplay();
            }
        }

        function previousSection() {
            if (currentSectionIndex > 0) {
                currentSectionIndex--;
                updateSectionDisplay();
            }
        }

        function updateSectionDisplay() {
            document.getElementById('currentSection').textContent = currentSectionIndex + 1;
            document.getElementById('transcriptContent').textContent = sections[currentSectionIndex];
            updateProgress();
        }

        // Visual Accessibility
        function changeTheme(theme) {
            // Clear all existing theme classes
            document.body.classList.remove('theme-yellow-black', 'theme-blue-white', 'theme-green-black', 'high-contrast');
            
            if (theme === 'high-contrast') {
                document.body.classList.add('high-contrast');
                forceHighContrastStyles();
            } else if (theme === 'yellow-black') {
                document.body.classList.add('theme-yellow-black');
                forceYellowBlackStyles();
            } else if (theme === 'blue-white') {
                document.body.classList.add('theme-blue-white');
                forceBlueWhiteStyles();
            } else if (theme === 'green-black') {
                document.body.classList.add('theme-green-black');
                forceGreenBlackStyles();
            } else if (theme === 'default') {
                // Reset to default - no special classes
                resetToDefaultStyles();
            }
        }

        function forceHighContrastStyles() {
            console.log('Applying forced high contrast styles...');
            
            // Force all text elements to be white
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('background-color', '#111111', 'important');
            });
            
            // Force all backgrounds to be dark
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#111111', 'important');
            });
            
            // Ensure header is visible
            const header = document.querySelector('.header');
            if (header) {
                header.style.setProperty('display', 'block', 'important');
                header.style.setProperty('visibility', 'visible', 'important');
                header.style.setProperty('background-color', '#111111', 'important');
                header.style.setProperty('color', '#ffffff', 'important');
            }
            
            console.log('High contrast styles applied');
        }

        function forceYellowBlackStyles() {
            console.log('Applying yellow-black theme styles...');
            
            // Force all text elements to be yellow
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#ffff00', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffff00', 'important');
                element.style.setProperty('background-color', '#000000', 'important');
            });
            
            // Force all backgrounds to be black
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#000000', 'important');
            });
            
            console.log('Yellow-black theme applied');
        }

        function forceBlueWhiteStyles() {
            console.log('Applying blue-white theme styles...');
            
            // Force all text elements to be white
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('background-color', '#000080', 'important');
            });
            
            // Force all backgrounds to be blue
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#000080', 'important');
            });
            
            console.log('Blue-white theme applied');
        }

        function forceGreenBlackStyles() {
            console.log('Applying green-black theme styles...');
            
            // Force all text elements to be green
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#00ff00', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#00ff00', 'important');
                element.style.setProperty('background-color', '#000000', 'important');
            });
            
            // Force all backgrounds to be black
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#000000', 'important');
            });
            
            console.log('Green-black theme applied');
        }

        function resetToDefaultStyles() {
            console.log('Resetting to default styles...');
            
            // Remove all forced styles
            const allElements = document.querySelectorAll('*');
            allElements.forEach(element => {
                element.style.removeProperty('color');
                element.style.removeProperty('background-color');
            });
            
            console.log('Default styles restored');
        }

        function changeFontSize(size) {
            document.body.style.fontSize = size + 'px';
            document.getElementById('transcriptContent').style.fontSize = size + 'px';
        }

        function changeLineSpacing(spacing) {
            document.body.style.lineHeight = spacing;
            document.getElementById('transcriptContent').style.lineHeight = spacing;
        }

        function changeLetterSpacing(spacing) {
            document.body.style.letterSpacing = spacing;
            document.getElementById('transcriptContent').style.letterSpacing = spacing;
        }

        // Fullscreen Mode
        function fullscreenMode() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Notes System
        function toggleNotes() {
            const notesSection = document.getElementById('notesSection');
            const btn = document.getElementById('notesBtn');
            
            if (notesSection.style.display === 'none') {
                notesSection.style.display = 'block';
                btn.textContent = 'Hide Notes';
                loadNotes();
            } else {
                notesSection.style.display = 'none';
                btn.textContent = 'Show Notes';
            }
        }

        function saveNotes() {
            const notes = document.getElementById('notesTextarea').value;
            localStorage.setItem('userNotes', notes);
            alert('Notes saved!');
        }

        function loadNotes() {
            const savedNotes = localStorage.getItem('userNotes');
            if (savedNotes) {
                document.getElementById('notesTextarea').value = savedNotes;
            }
        }

        function clearNotes() {
            if (confirm('Are you sure you want to clear all notes?')) {
                document.getElementById('notesTextarea').value = '';
                localStorage.removeItem('userNotes');
            }
        }

        // Achievement System
        function checkAchievements(progress) {
            const newAchievements = [];
            
            if (progress >= 25 && !achievements.includes('quarter')) {
                newAchievements.push({ icon: '📖', text: 'Quarter Complete - 25% read' });
                achievements.push('quarter');
            }
            
            if (progress >= 50 && !achievements.includes('halfway')) {
                newAchievements.push({ icon: '🎯', text: 'Halfway There - 50% complete' });
                achievements.push('halfway');
            }
            
            if (progress >= 75 && !achievements.includes('almost')) {
                newAchievements.push({ icon: '🚀', text: 'Almost Done - 75% finished' });
                achievements.push('almost');
            }
            
            if (progress >= 100 && !achievements.includes('complete')) {
                newAchievements.push({ icon: '🏆', text: 'Complete! - 100% finished' });
                achievements.push('complete');
            }
            
            if (newAchievements.length > 0) {
                showAchievements(newAchievements);
            }
        }

        function showAchievements(newAchievements) {
            const achievementsDiv = document.getElementById('achievements');
            const list = document.getElementById('achievementsList');
            
            newAchievements.forEach(achievement => {
                const div = document.createElement('div');
                div.className = 'achievement';
                div.innerHTML = `<span class="achievement-icon">${achievement.icon}</span>${achievement.text}`;
                list.appendChild(div);
            });
            
            achievementsDiv.style.display = 'block';
            
            setTimeout(() => {
                achievementsDiv.style.display = 'none';
            }, 5000);
        }

        // Translation Functions
        function translateToSpanish() {
            const transcript = document.getElementById('transcriptContent');
            const text = transcript.textContent;
            
            // Store original content before first translation
            if (!window.originalTranscriptContent) {
                window.originalTranscriptContent = text;
            }
            
            // Use Google Translate API or browser translation
            // For now, show a message that translation requires external service
            alert('Translation to Spanish requires an external translation service. Please copy the text and use Google Translate or another translation tool.');
            
            // Alternative: Use browser's built-in translation if available
            if (window.google && window.google.translate) {
                // This would require Google Translate API integration
                console.log('Google Translate API not available');
            }
            
            document.getElementById('voiceSelect').value = 'es-ES';
        }

        function translateToFrench() {
            const transcript = document.getElementById('transcriptContent');
            const text = transcript.textContent;
            
            // Store original content before first translation
            if (!window.originalTranscriptContent) {
                window.originalTranscriptContent = text;
            }
            
            // Use Google Translate API or browser translation
            // For now, show a message that translation requires external service
            alert('Translation to French requires an external translation service. Please copy the text and use Google Translate or another translation tool.');
            
            // Alternative: Use browser's built-in translation if available
            if (window.google && window.google.translate) {
                // This would require Google Translate API integration
                console.log('Google Translate API not available');
            }
            
            document.getElementById('voiceSelect').value = 'fr-FR';
        }

        function translateToGerman() {
            const transcript = document.getElementById('transcriptContent');
            const text = transcript.textContent;
            
            // Store original content before first translation
            if (!window.originalTranscriptContent) {
                window.originalTranscriptContent = text;
            }
            
            // Use Google Translate API or browser translation
            // For now, show a message that translation requires external service
            alert('Translation to German requires an external translation service. Please copy the text and use Google Translate or another translation tool.');
            
            // Alternative: Use browser's built-in translation if available
            if (window.google && window.google.translate) {
                // This would require Google Translate API integration
                console.log('Google Translate API not available');
            }
            
            document.getElementById('voiceSelect').value = 'de-DE';
        }

        function resetTranslation() {
            // Store the current transcript content before translation
            const transcript = document.getElementById('transcriptContent');
            const currentContent = transcript.textContent;
            
            // If we have a stored original content, restore it; otherwise keep current content
            if (window.originalTranscriptContent) {
                transcript.textContent = window.originalTranscriptContent;
            } else {
                // If no original content stored, just reset the voice to English
                window.originalTranscriptContent = currentContent;
            }
            
            document.getElementById('voiceSelect').value = 'en-US';
        }

        // Voice Input Functions
        let recognition = null;
        let isListening = false;

        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser. Please use Chrome or Edge.');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            const language = document.getElementById('voiceLanguageSelect').value;
            recognition.lang = language;
            recognition.continuous = true;
            recognition.interimResults = true;
            
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceInputBtn = document.getElementById('voiceInputBtn');
            const stopVoiceBtn = document.getElementById('stopVoiceBtn');
            
            recognition.onstart = function() {
                isListening = true;
                voiceStatus.textContent = '🎤 Listening... Speak now!';
                voiceStatus.style.color = '#28a745';
                voiceInputBtn.style.display = 'none';
                stopVoiceBtn.style.display = 'inline-block';
            };
            
            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (finalTranscript) {
                    // Store original content before first voice input
                    if (!window.originalTranscriptContent) {
                        window.originalTranscriptContent = document.getElementById('transcriptContent').textContent;
                    }
                    
                    // Append the voice input to the transcript
                    const transcriptContent = document.getElementById('transcriptContent');
                    const currentText = transcriptContent.textContent;
                    transcriptContent.textContent = currentText + '\n\n' + finalTranscript;
                    
                    voiceStatus.textContent = '✅ Added: ' + finalTranscript.substring(0, 50) + (finalTranscript.length > 50 ? '...' : '');
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                voiceStatus.textContent = '❌ Error: ' + event.error;
                voiceStatus.style.color = '#dc3545';
                stopVoiceInput();
            };
            
            recognition.onend = function() {
                if (isListening) {
                    // Restart if still listening
                    recognition.start();
                } else {
                    voiceStatus.textContent = '🎤 Voice input stopped';
                    voiceStatus.style.color = '#666';
                    voiceInputBtn.style.display = 'inline-block';
                    stopVoiceBtn.style.display = 'none';
                }
            };
            
            recognition.start();
        }
        
        function stopVoiceInput() {
            isListening = false;
            if (recognition) {
                recognition.stop();
            }
        }

        // Video Processing Functions
        function showVideoInput() {
            document.getElementById('videoInputSection').style.display = 'block';
            document.getElementById('transcriptInputSection').style.display = 'none';
            document.getElementById('videoTab').style.background = '#007bff';
            document.getElementById('transcriptTab').style.background = '#6c757d';
        }

        function showTranscriptInput() {
            document.getElementById('videoInputSection').style.display = 'none';
            document.getElementById('transcriptInputSection').style.display = 'block';
            document.getElementById('videoTab').style.background = '#6c757d';
            document.getElementById('transcriptTab').style.background = '#007bff';
        }

        async function processVideoFile() {
            console.log('processVideoFile started');
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            
            console.log('File selected:', file);
            
            if (!file) {
                alert('Please select a video or audio file first.');
                return;
            }

            console.log('File type:', file.type);
            console.log('File size:', file.size);

            // Accept both video and audio files
            if (!file.type.startsWith('video/') && !file.type.startsWith('audio/')) {
                alert('Please select a valid video or audio file.');
                return;
            }

            showProcessingStatus('Processing file...');
            
            try {
                console.log('Starting file processing...');
                updateProgress(20);
                updateStatus('Preparing file for transcription...');
                
                // For audio files, we can try to decode them
                if (file.type.startsWith('audio/')) {
                    console.log('Processing audio file...');
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const arrayBuffer = await file.arrayBuffer();
                    
                    console.log('Array buffer created, size:', arrayBuffer.byteLength);
                    updateProgress(40);
                    updateStatus('Decoding audio...');
                    
                    try {
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        console.log('Audio decoded successfully');
                        const audioData = convertAudioBufferToAudioData(audioBuffer);
                        
                        updateProgress(60);
                        updateStatus('Transcribing audio...');
                        
                        console.log('Starting transcription...');
                        const transcript = await transcribeAudio(audioData);
                        console.log('Transcription completed');
                        
                        updateProgress(90);
                        updateStatus('Loading transcript...');
                        
                        document.getElementById('transcriptContent').textContent = transcript;
                        // Store the original transcript content for translation reset
                        window.originalTranscriptContent = transcript;
                        
                        updateProgress(100);
                        updateStatus('Audio processed successfully!');
                        
                    } catch (decodeError) {
                        console.warn('Could not decode audio, trying direct upload:', decodeError);
                        // Fallback to direct file upload
                        await processFileDirectly(file);
                    }
                } else {
                    // For video files, we'll try to extract audio, but if that fails, 
                    // we'll suggest using an audio file instead
                    updateStatus('Video files may not work well with this method. Please try converting your video to audio first, or use the manual transcript option.');
                    setTimeout(() => {
                        hideProcessingStatus();
                        alert('Video processing is limited. Please:\n1. Convert your video to audio (MP3, WAV, etc.) and upload that instead, or\n2. Use the manual transcript option to paste your transcript.');
                    }, 3000);
                    return;
                }
                
                // Clear any existing AI-generated content
                const flashcardsContainer = document.getElementById('flashcardsContainer');
                const quizContainer = document.getElementById('quizContainer');
                const studyMaterialsContainer = document.getElementById('studyMaterials');
                
                // Hide containers (don't clear innerHTML to preserve child elements)
                flashcardsContainer.style.display = 'none';
                
                quizContainer.style.display = 'none';
                
                studyMaterialsContainer.style.display = 'none';
                
                // Reset counters and arrays
                currentCardIndex = 0;
                currentQuestionIndex = 0;
                flashcards = [];
                quizQuestions = [];
                
                // Reset text-to-speech
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
                isReading = false;
                isPaused = false;
                currentUtterance = null;
                
                setTimeout(() => {
                    hideProcessingStatus();
                    alert('File processed successfully! You can now generate AI-powered study materials.');
                }, 1000);
                
            } catch (error) {
                console.error('Error processing file:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                hideProcessingStatus();
                alert('Error processing file: ' + error.message + '\n\nPlease try again or use manual transcript input.');
            }
        }

        async function processFileDirectly(file) {
            updateProgress(60);
            updateStatus('Transcribing file directly...');
            
            const transcript = await transcribeFileDirectly(file);
            
            updateProgress(90);
            updateStatus('Loading transcript...');
            
            document.getElementById('transcriptContent').textContent = transcript;
            // Store the original transcript content for translation reset
            window.originalTranscriptContent = transcript;
            
            updateProgress(100);
            updateStatus('File processed successfully!');
        }

        async function transcribeFileDirectly(file) {
            console.log('transcribeFileDirectly started');
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                throw new Error('OpenAI API key required for transcription');
            }
            console.log('API key found, length:', apiKey.length);

            console.log('Sending request to OpenAI API...');
            const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                },
                body: (() => {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('model', 'whisper-1');
                    return formData;
                })()
            });

            console.log('Response received:', response.status, response.statusText);
            if (!response.ok) {
                console.error('API response not ok:', response.status, response.statusText);
                const errorData = await response.json();
                console.error('Error data:', errorData);
                throw new Error(`Transcription failed: ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();
            console.log('Transcription result:', result);
            return result.text;
        }

        async function processVideoUrl() {
            const urlInput = document.getElementById('videoUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Please enter a video URL first.');
                return;
            }

            if (!isValidVideoUrl(url)) {
                alert('Please enter a valid video URL (YouTube, Vimeo, etc.).');
                return;
            }

            showProcessingStatus('Processing video URL...');
            
            try {
                updateProgress(20);
                updateStatus('Downloading video...');
                
                // For YouTube URLs, we'll use a proxy service or suggest manual download
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    updateStatus('YouTube videos require manual download. Please download the video and upload it as a file.');
                    setTimeout(() => {
                        hideProcessingStatus();
                        alert('For YouTube videos, please download the video file first and then upload it using the file upload option.');
                    }, 2000);
                    return;
                }
                
                // For other URLs, attempt to fetch (this may not work due to CORS)
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Could not download video from URL');
                }
                
                const blob = await response.blob();
                const file = new File([blob], 'video.mp4', { type: 'video/mp4' });
                
                // Process the downloaded file
                await processVideoFileFromBlob(file);
                
            } catch (error) {
                console.error('Error processing video URL:', error);
                hideProcessingStatus();
                alert('Could not process video URL. Please download the video and upload it as a file, or use manual transcript input.');
            }
        }

        async function processVideoFileFromBlob(file) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                updateProgress(60);
                updateStatus('Transcribing audio...');
                
                const audioData = convertAudioBufferToAudioData(audioBuffer);
                const transcript = await transcribeAudio(audioData);
                
                updateProgress(90);
                updateStatus('Loading transcript...');
                
                document.getElementById('transcriptContent').textContent = transcript;
                // Store the original transcript content for translation reset
                window.originalTranscriptContent = transcript;
                
                // Show status indicator
                const statusIndicator = document.getElementById('transcriptStatus');
                statusIndicator.style.display = 'block';
                
                updateProgress(100);
                updateStatus('Video processed successfully!');
                
                // Clear any existing AI-generated content
                const flashcardsContainer = document.getElementById('flashcardsContainer');
                const quizContainer = document.getElementById('quizContainer');
                const studyMaterialsContainer = document.getElementById('studyMaterials');
                
                // Hide containers (don't clear innerHTML to preserve child elements)
                flashcardsContainer.style.display = 'none';
                
                quizContainer.style.display = 'none';
                
                studyMaterialsContainer.style.display = 'none';
                
                // Reset counters and arrays
                currentCardIndex = 0;
                currentQuestionIndex = 0;
                flashcards = [];
                quizQuestions = [];
                
                // Reset text-to-speech
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
                isReading = false;
                isPaused = false;
                currentUtterance = null;
                
                // Update progress after loading content
                updateProgress();
                
                setTimeout(() => {
                    hideProcessingStatus();
                    alert('Video processed successfully! You can now generate AI-powered study materials.');
                }, 1000);
                
            } catch (error) {
                console.error('Error processing video file:', error);
                hideProcessingStatus();
                alert('Error processing video. Please try again or use manual transcript input.');
            }
        }

        function convertAudioBufferToAudioData(audioBuffer) {
            // Convert AudioBuffer to format suitable for transcription
            const channels = audioBuffer.numberOfChannels;
            const length = audioBuffer.length;
            const sampleRate = audioBuffer.sampleRate;
            
            // Get the first channel (mono) or mix all channels
            let audioData;
            if (channels === 1) {
                audioData = audioBuffer.getChannelData(0);
            } else {
                // Mix multiple channels to mono
                audioData = new Float32Array(length);
                for (let i = 0; i < length; i++) {
                    let sum = 0;
                    for (let ch = 0; ch < channels; ch++) {
                        sum += audioBuffer.getChannelData(ch)[i];
                    }
                    audioData[i] = sum / channels;
                }
            }
            
            return {
                data: audioData,
                sampleRate: sampleRate,
                duration: length / sampleRate
            };
        }

        async function transcribeAudio(audioData) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                throw new Error('OpenAI API key required for transcription');
            }

            // Convert audio data to WAV blob
            const audioBlob = audioDataToBlob(audioData);

            const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                    // Don't set Content-Type - browser will set it automatically with boundary for FormData
                },
                body: (() => {
                    const formData = new FormData();
                    formData.append('file', audioBlob, 'audio.wav');
                    formData.append('model', 'whisper-1');
                    return formData;
                })()
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Transcription failed: ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();
            return result.text;
        }

        function audioDataToBlob(audioData) {
            // Convert Float32Array to WAV format
            const buffer = new ArrayBuffer(44 + audioData.data.length * 2);
            const view = new DataView(buffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + audioData.data.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, audioData.sampleRate, true);
            view.setUint32(28, audioData.sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, audioData.data.length * 2, true);
            
            // Audio data
            let offset = 44;
            for (let i = 0; i < audioData.data.length; i++) {
                const sample = Math.max(-1, Math.min(1, audioData.data[i]));
                view.setInt16(offset, sample * 0x7FFF, true);
                offset += 2;
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function isValidVideoUrl(url) {
            const videoPatterns = [
                /youtube\.com\/watch\?v=/,
                /youtu\.be\//,
                /vimeo\.com\//,
                /\.mp4$/,
                /\.webm$/,
                /\.mov$/
            ];
            return videoPatterns.some(pattern => pattern.test(url));
        }

        function showProcessingStatus(message) {
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('statusText').textContent = message;
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function hideProcessingStatus() {
            document.getElementById('processingStatus').style.display = 'none';
        }

        // Transcript Loading Functions
        function loadCustomTranscript() {
            const input = document.getElementById('transcriptInput');
            const transcript = document.getElementById('transcriptContent');
            
            if (!input.value.trim()) {
                alert('Please enter a transcript first.');
                return;
            }
            
            const newTranscript = input.value.trim();
            transcript.textContent = newTranscript;
            
            // Store the original transcript content for translation reset
            window.originalTranscriptContent = newTranscript;
            
            // Show status indicator
            const statusIndicator = document.getElementById('transcriptStatus');
            statusIndicator.style.display = 'block';
            
            // Clear any existing AI-generated content
            const flashcardsContainer = document.getElementById('flashcardsContainer');
            const quizContainer = document.getElementById('quizContainer');
            const studyMaterialsContainer = document.getElementById('studyMaterials');
            
            // Hide containers (don't clear innerHTML to preserve child elements)
            flashcardsContainer.style.display = 'none';
            
            quizContainer.style.display = 'none';
            
            studyMaterialsContainer.style.display = 'none';
            
            // Reset counters and arrays
            currentCardIndex = 0;
            currentQuestionIndex = 0;
            flashcards = [];
            quizQuestions = [];
            
            // Reset text-to-speech
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            isReading = false;
            isPaused = false;
            currentUtterance = null;
            
            // Update progress after loading content
            updateProgress();
            
            // Show success message
            alert('Transcript loaded successfully! You can now generate AI-powered study materials using the buttons below.');
        }

        function loadDefaultTranscript() {
            const transcript = document.getElementById('transcriptContent');
            const foilTranscript = `The FOIL method is a technique used to multiply two binomials. FOIL stands for First, Outer, Inner, Last. Let's break this down step by step.

When you have two binomials like (a + b) and (c + d), you multiply them using the FOIL method:

First: Multiply the first terms of each binomial (a × c)
Outer: Multiply the outer terms (a × d)
Inner: Multiply the inner terms (b × c)
Last: Multiply the last terms of each binomial (b × d)

Then you add all these products together: ac + ad + bc + bd

Let's work through an example: (x + 3)(x + 2)

First: x × x = x²
Outer: x × 2 = 2x
Inner: 3 × x = 3x
Last: 3 × 2 = 6

Adding them together: x² + 2x + 3x + 6 = x² + 5x + 6

This method helps you remember to multiply every term in the first binomial by every term in the second binomial, ensuring you don't miss any combinations.`;
            
            transcript.textContent = foilTranscript;
            
            // Store the original transcript content for translation reset
            window.originalTranscriptContent = foilTranscript;
            
            // Show status indicator
            const statusIndicator = document.getElementById('transcriptStatus');
            statusIndicator.style.display = 'block';
            
            // Clear any existing AI-generated content
            const flashcardsContainer = document.getElementById('flashcardsContainer');
            const quizContainer = document.getElementById('quizContainer');
            const studyMaterialsContainer = document.getElementById('studyMaterials');
            
            // Hide containers (don't clear innerHTML to preserve child elements)
            flashcardsContainer.style.display = 'none';
            
            quizContainer.style.display = 'none';
            
            studyMaterialsContainer.style.display = 'none';
            
            // Reset counters and arrays
            currentCardIndex = 0;
            currentQuestionIndex = 0;
            flashcards = [];
            quizQuestions = [];
            
            // Reset text-to-speech
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            isReading = false;
            isPaused = false;
            currentUtterance = null;
            
            // Update progress after loading content
            updateProgress();
            
            alert('Default FOIL method transcript loaded!');
        }



        // AI Integration
        async function generateFlashcards() {
            console.log('=== GENERATE FLASHCARDS STARTED ===');
            
            // Clear any previous flashcard content to ensure fresh generation
            let flashcardDisplay = document.getElementById('flashcardDisplay');
            if (flashcardDisplay) {
                flashcardDisplay.innerHTML = '';
            }
            
            // Get the container first and make it visible
            const flashcardsContainer = document.getElementById('flashcardsContainer');
            if (!flashcardsContainer) {
                console.error('flashcardsContainer not found');
                alert('Error: Flashcards container not found. Please refresh the page and try again.');
                return;
            }
            
            // Make the container visible so child elements can be accessed
            flashcardsContainer.style.display = 'block';
            
            // Now get the child elements
            flashcardDisplay = document.getElementById('flashcardDisplay');
            const cardCounter = document.getElementById('cardCounter');
            const transcriptContent = document.getElementById('transcriptContent');
            
            // Check if child elements exist
            if (!flashcardDisplay || !cardCounter || !transcriptContent) {
                console.error('Child elements missing:', {
                    flashcardDisplay: !!flashcardDisplay,
                    cardCounter: !!cardCounter,
                    transcriptContent: !!transcriptContent
                });
                alert('Error: Some required elements are missing. Please refresh the page and try again.');
                return;
            }
            
            console.log('All elements found, proceeding with flashcard generation...');
            
            // Check if transcript has content
            const transcriptText = transcriptContent.textContent.trim();
            if (transcriptText.length < 50) {
                alert('Please load a transcript first (at least 50 characters).');
                return;
            }
            
            // Check API key
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                return;
            }
            
            // Show loading indicator
            flashcardDisplay.innerHTML = '<div style="text-align: center; padding: 20px; color: #0066cc;">🔄 Generating flashcards...</div>';
            flashcardsContainer.style.display = 'block';
            
            try {
                console.log('Making API request to OpenAI...');
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'user',
                            content: `Create 5 flashcards from this transcript. Format each flashcard as: "Question: [question] Answer: [answer]". Do not use any numbering or prefixes like "Flashcard 1:" or "Card 1:". Keep questions and answers concise and educational.\n\nTranscript: ${transcriptText}`
                        }],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                console.log('API response received');
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error:', errorData);
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API data parsed:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from OpenAI API');
                }
                
                const content = data.choices[0].message.content;
                console.log('Generated content:', content);
                console.log('Content type:', typeof content);
                console.log('Content length:', content ? content.length : 'undefined');
                
                // Parse flashcards with improved regex - split by Question: to ensure proper order
                console.log('Raw API content for parsing:', content);
                
                // First, let's try to identify the format of the response
                if (content.includes('Question:') && content.includes('Answer:')) {
                    console.log('Content contains Question: and Answer: markers');
                    const questionBlocks = content.split(/Question:\s*/).filter(block => block.trim());
                    console.log('Question blocks found:', questionBlocks.length);
                    
                    flashcards = questionBlocks.map((block, index) => {
                        console.log(`Processing block ${index}:`, block);
                        
                        if (!block.includes('Answer:')) {
                            console.warn('Block missing Answer:', block);
                            return null;
                        }
                        
                        const parts = block.split(/Answer:\s*/);
                        if (parts.length < 2) {
                            console.warn('Invalid block format:', block);
                            return null;
                        }
                        
                        let question = parts[0].trim();
                        let answer = parts[1].trim();
                        
                        // Clean up any numbering or prefixes from the AI response
                        question = question.replace(/^(Flashcard\s*\d+:|Card\s*\d+:|Q\d*\.?\s*)/i, '').trim();
                        answer = answer.replace(/^(Flashcard\s*\d+:|Card\s*\d+:|A\d*\.?\s*)/i, '').trim();
                        
                        // Additional validation
                        if (!question || !answer) {
                            console.warn('Empty question or answer:', { question, answer });
                            return null;
                        }
                        
                        // Simple and conservative smart detection for flashcard inversion
                        const questionEndsWithQuestionMark = question.endsWith('?');
                        const answerEndsWithQuestionMark = answer.endsWith('?');
                        
                        // Check for common question words in the "question" part
                        const questionWords = ['what', 'when', 'where', 'why', 'how', 'which', 'who', 'whose', 'whom'];
                        const questionLower = question.toLowerCase();
                        const hasQuestionWords = questionWords.some(word => questionLower.includes(word));
                        
                        // Check for common answer indicators in the "answer" part
                        const answerIndicators = ['is', 'are', 'was', 'were', 'will', 'would', 'could', 'should', 'can', 'may', 'might', 'the', 'a', 'an'];
                        const answerLower = answer.toLowerCase();
                        const hasAnswerIndicators = answerIndicators.some(word => answerLower.startsWith(word));
                        
                        console.log(`Card ${index} analysis:`, {
                            questionEndsWithQuestionMark,
                            answerEndsWithQuestionMark,
                            hasQuestionWords,
                            hasAnswerIndicators,
                            question: question.substring(0, 50) + (question.length > 50 ? '...' : ''),
                            answer: answer.substring(0, 50) + (answer.length > 50 ? '...' : '')
                        });
                        
                        // Conservative detection logic - only swap when clearly inverted
                        let shouldSwap = false;
                        
                        // Case 1: Clear question mark mismatch - answer has ? but question doesn't
                        if (!questionEndsWithQuestionMark && answerEndsWithQuestionMark) {
                            shouldSwap = true;
                            console.log(`Card ${index}: Detected inversion by question mark - swapping Q&A`);
                        }
                        // Case 2: Answer starts with question words - definitely inverted
                        else if (questionWords.some(word => answerLower.startsWith(word))) {
                            shouldSwap = true;
                            console.log(`Card ${index}: Detected inversion by answer starting with question word - swapping Q&A`);
                        }
                        // Case 3: Question has answer indicators and answer has question words - likely inverted
                        else if (hasAnswerIndicators && questionWords.some(word => answerLower.includes(word))) {
                            shouldSwap = true;
                            console.log(`Card ${index}: Detected inversion by mixed indicators - swapping Q&A`);
                        }
                        
                        if (shouldSwap) {
                            [question, answer] = [answer, question];
                        }
                        
                        // Debug logging to check if question and answer are correct
                        console.log(`Parsed flashcard ${index}:`, { question, answer });
                        
                        return { question, answer };
                    }).filter(card => card !== null); // Remove any null entries
                } else {
                    console.log('Content does not contain standard Question:/Answer: format, trying alternative parsing');
                    // Try alternative parsing if the format is different
                    const lines = content.split('\n').filter(line => line.trim());
                    console.log('Content lines:', lines);
                    
                    flashcards = [];
                    let currentQuestion = '';
                    let currentAnswer = '';
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('Q:') || line.startsWith('Question:')) {
                            if (currentQuestion && currentAnswer) {
                                // Apply simple and conservative smart detection before adding the card
                                let question = currentQuestion;
                                let answer = currentAnswer;
                                
                                const questionEndsWithQuestionMark = question.endsWith('?');
                                const answerEndsWithQuestionMark = answer.endsWith('?');
                                
                                // Check for common question words in the "question" part
                                const questionWords = ['what', 'when', 'where', 'why', 'how', 'which', 'who', 'whose', 'whom'];
                                const questionLower = question.toLowerCase();
                                const hasQuestionWords = questionWords.some(word => questionLower.includes(word));
                                
                                // Check for common answer indicators in the "answer" part
                                const answerIndicators = ['is', 'are', 'was', 'were', 'will', 'would', 'could', 'should', 'can', 'may', 'might', 'the', 'a', 'an'];
                                const answerLower = answer.toLowerCase();
                                const hasAnswerIndicators = answerIndicators.some(word => answerLower.startsWith(word));
                                
                                // Conservative detection logic - only swap when clearly inverted
                                let shouldSwap = false;
                                
                                // Case 1: Clear question mark mismatch - answer has ? but question doesn't
                                if (!questionEndsWithQuestionMark && answerEndsWithQuestionMark) {
                                    shouldSwap = true;
                                    console.log('Alternative parsing: Detected inversion by question mark - swapping Q&A');
                                }
                                // Case 2: Answer starts with question words - definitely inverted
                                else if (questionWords.some(word => answerLower.startsWith(word))) {
                                    shouldSwap = true;
                                    console.log('Alternative parsing: Detected inversion by answer starting with question word - swapping Q&A');
                                }
                                // Case 3: Question has answer indicators and answer has question words - likely inverted
                                else if (hasAnswerIndicators && questionWords.some(word => answerLower.includes(word))) {
                                    shouldSwap = true;
                                    console.log('Alternative parsing: Detected inversion by mixed indicators - swapping Q&A');
                                }
                                
                                if (shouldSwap) {
                                    [question, answer] = [answer, question];
                                }
                                
                                flashcards.push({ question, answer });
                            }
                            currentQuestion = line.replace(/^(Q:|Question:|Flashcard\s*\d+:|Card\s*\d+:)\s*/, '').trim();
                            currentAnswer = '';
                        } else if (line.startsWith('A:') || line.startsWith('Answer:')) {
                            currentAnswer = line.replace(/^(A:|Answer:|Flashcard\s*\d+:|Card\s*\d+:)\s*/, '').trim();
                        } else if (currentQuestion && !currentAnswer) {
                            // This might be a continuation of the question
                            currentQuestion += ' ' + line;
                        } else if (currentAnswer) {
                            // This might be a continuation of the answer
                            currentAnswer += ' ' + line;
                        }
                    }
                    
                    // Add the last card if we have both question and answer
                    if (currentQuestion && currentAnswer) {
                        // Apply simple and conservative smart detection before adding the last card
                        let question = currentQuestion;
                        let answer = currentAnswer;
                        
                        const questionEndsWithQuestionMark = question.endsWith('?');
                        const answerEndsWithQuestionMark = answer.endsWith('?');
                        
                        // Check for common question words in the "question" part
                        const questionWords = ['what', 'when', 'where', 'why', 'how', 'which', 'who', 'whose', 'whom'];
                        const questionLower = question.toLowerCase();
                        const hasQuestionWords = questionWords.some(word => questionLower.includes(word));
                        
                        // Check for common answer indicators in the "answer" part
                        const answerIndicators = ['is', 'are', 'was', 'were', 'will', 'would', 'could', 'should', 'can', 'may', 'might', 'the', 'a', 'an'];
                        const answerLower = answer.toLowerCase();
                        const hasAnswerIndicators = answerIndicators.some(word => answerLower.startsWith(word));
                        
                        // Conservative detection logic - only swap when clearly inverted
                        let shouldSwap = false;
                        
                        // Case 1: Clear question mark mismatch - answer has ? but question doesn't
                        if (!questionEndsWithQuestionMark && answerEndsWithQuestionMark) {
                            shouldSwap = true;
                            console.log('Alternative parsing (last card): Detected inversion by question mark - swapping Q&A');
                        }
                        // Case 2: Answer starts with question words - definitely inverted
                        else if (questionWords.some(word => answerLower.startsWith(word))) {
                            shouldSwap = true;
                            console.log('Alternative parsing (last card): Detected inversion by answer starting with question word - swapping Q&A');
                        }
                        // Case 3: Question has answer indicators and answer has question words - likely inverted
                        else if (hasAnswerIndicators && questionWords.some(word => answerLower.includes(word))) {
                            shouldSwap = true;
                            console.log('Alternative parsing (last card): Detected inversion by mixed indicators - swapping Q&A');
                        }
                        
                        if (shouldSwap) {
                            [question, answer] = [answer, question];
                        }
                        
                        flashcards.push({ question, answer });
                    }
                }
                
                if (!flashcards || flashcards.length === 0) {
                    throw new Error('Could not parse flashcards from API response');
                }
                
                console.log('Parsed flashcards:', flashcards);
                
                if (flashcards.length === 0) {
                    throw new Error('No valid flashcards could be extracted');
                }
                
                // Display flashcards
                displayFlashcards();
                
            } catch (error) {
                console.error('Error generating flashcards:', error);
                flashcardDisplay.innerHTML = `<div style="color: red; padding: 20px;">Error generating flashcards: ${error.message}. Please check your API key and try again.</div>`;
            }
        }

        function displayFlashcards() {
            console.log('=== DISPLAYING FLASHCARDS ===');
            const container = document.getElementById('flashcardsContainer');
            const display = document.getElementById('flashcardDisplay');
            
            console.log('Flashcards container:', container);
            console.log('Flashcard display:', display);
            console.log('Number of flashcards:', flashcards.length);
            
            // Check if elements exist before proceeding
            if (!container) {
                console.error('flashcardsContainer not found!');
                alert('Error: Flashcards container not found. Please refresh the page.');
                return;
            }
            
            if (!display) {
                console.error('flashcardDisplay not found!');
                alert('Error: Flashcard display not found. Please refresh the page.');
                return;
            }
            
            // Reset flashcard state
            currentCardIndex = 0;
            
            container.style.display = 'block';
            
            const quizContainer = document.getElementById('quizContainer');
            const studyMaterials = document.getElementById('studyMaterials');
            
            if (quizContainer) quizContainer.style.display = 'none';
            if (studyMaterials) studyMaterials.style.display = 'none';
            

            
            showCurrentCard();
        }

        function showCurrentCard() {
            if (flashcards.length === 0) return;
            
            const card = flashcards[currentCardIndex];
            const display = document.getElementById('flashcardDisplay');
            const cardCounter = document.getElementById('cardCounter');
            
            // Check if elements exist before proceeding
            if (!display) {
                console.error('flashcardDisplay not found in showCurrentCard!');
                return;
            }
            
            if (!cardCounter) {
                console.error('cardCounter not found in showCurrentCard!');
                return;
            }
            
            // Reset card to front side with enhanced styling
            display.innerHTML = `
                <div class="flashcard" onclick="flipCard()" style="perspective: 1000px; width: 100%; height: 200px; position: relative; transition: transform 0.6s; transform-style: preserve-3d;">
                    <div id="cardFront" style="display: block; position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background: white; border: 2px solid #ddd; border-radius: 10px; padding: 20px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">${card.question}</div>
                    <div id="cardBack" style="display: none; position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background: #f8f9fa; border: 2px solid #007bff; border-radius: 10px; padding: 20px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: rotateY(180deg);">${card.answer}</div>
                </div>
            `;
            
            cardCounter.textContent = `Card ${currentCardIndex + 1} of ${flashcards.length}`;
        }

        function flipCard() {
            const front = document.getElementById('cardFront');
            const back = document.getElementById('cardBack');
            const card = document.querySelector('.flashcard');
            
            // Check if elements exist before proceeding
            if (!front || !back || !card) {
                console.error('Card elements not found in flipCard!');
                return;
            }
            
            // Use 3D transform for smooth flip animation
            if (card.style.transform === 'rotateY(180deg)' || card.style.transform === '') {
                card.style.transform = 'rotateY(180deg)';
            } else {
                card.style.transform = 'rotateY(0deg)';
            }
        }

        function nextCard() {
            if (currentCardIndex < flashcards.length - 1) {
                currentCardIndex++;
                showCurrentCard();
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                showCurrentCard();
            }
        }

        // Quiz Generation
        async function generateQuiz() {
            console.log('=== GENERATE QUIZ STARTED ===');
            
            // Clear any previous quiz content to ensure fresh generation
            const quizDisplay = document.getElementById('quizDisplay');
            if (quizDisplay) {
                quizDisplay.innerHTML = '';
            }
            
            // Check if required elements exist
            const quizContainer = document.getElementById('quizContainer');
            const transcriptContent = document.getElementById('transcriptContent');
            
            if (!quizContainer || !quizDisplay || !transcriptContent) {
                console.error('Required quiz elements not found:', {
                    quizContainer: !!quizContainer,
                    quizDisplay: !!quizDisplay,
                    transcriptContent: !!transcriptContent
                });
                alert('Error: Required quiz elements not found. Please refresh the page and try again.');
                return;
            }
            
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                return;
            }

            const transcript = document.getElementById('transcriptContent').textContent;
            console.log('Quiz generation - Transcript length:', transcript.length);
            console.log('Quiz generation - Transcript preview:', transcript.substring(0, 200) + '...');
            console.log('Quiz generation - Full transcript content:', transcript);
            
            // Check if transcript contains FOIL content
            if (transcript.includes('FOIL method') || transcript.includes('First, Outer, Inner, Last')) {
                console.warn('WARNING: Transcript contains FOIL content - this might be the default transcript!');
            }
            
            // Check if transcript has meaningful content
            if (!transcript || transcript.trim().length < 50) {
                alert('Please load a transcript first. The current transcript is too short or empty.');
                return;
            }
            
            console.log('Generating quiz for transcript length:', transcript.length);
            
            const container = document.getElementById('quizContainer');
            container.style.display = 'block';
            document.getElementById('flashcardsContainer').style.display = 'none';
            document.getElementById('studyMaterials').style.display = 'none';
            
            // Reset flashcard state when switching to quiz
            resetFlashcardState();
            
            try {
                console.log('Making quiz API request to OpenAI...');
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'user',
                            content: `Create 5 multiple choice questions from this transcript. Format each question as:
Question: [question text]
A) [option A]
B) [option B] 
C) [option C]
D) [option D]
Answer: [A, B, C, or D]

Make questions clear and educational based on the transcript content.

Transcript: ${transcript}`
                        }],
                        temperature: 0.7
                    })
                });

                console.log('Quiz API response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Quiz API Error response:', errorData);
                    throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log('Quiz API response:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    console.error('Invalid API response structure:', data);
                    throw new Error('Invalid response format from OpenAI API');
                }
                
                const content = data.choices[0].message.content;
                console.log('Quiz API response content:', content);
                console.log('Quiz API response content type:', typeof content);
                console.log('Quiz API response content length:', content ? content.length : 'undefined');
                
                // Parse questions from text format (since we're using text format now)
                console.log('Parsing quiz from text format...');
                const lines = content.split('\n').filter(line => line.trim());
                console.log('Content lines:', lines);
                
                const extractedQuestions = [];
                let currentQuestion = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    console.log(`Processing line ${i}: "${line}"`);
                    
                    // Look for question patterns
                    if (line.match(/^Question:/i)) {
                        if (currentQuestion && currentQuestion.options.length >= 2) {
                            extractedQuestions.push(currentQuestion);
                            console.log('Added question:', currentQuestion);
                        }
                        currentQuestion = {
                            question: line.replace(/^Question:\s*/i, '').trim(),
                            options: [],
                            correct: 0
                        };
                        console.log('Started new question:', currentQuestion.question);
                    } else if (line.match(/^[A-D]\)\s/) && currentQuestion) {
                        // Extract option
                        const option = line.replace(/^[A-D]\)\s*/, '').trim();
                        currentQuestion.options.push(option);
                        console.log(`Added option ${currentQuestion.options.length}:`, option);
                    } else if (line.match(/^Answer:\s*[A-D]/i) && currentQuestion) {
                        // Extract correct answer
                        const answerMatch = line.match(/^Answer:\s*([A-D])/i);
                        if (answerMatch) {
                            const correctIndex = 'ABCD'.indexOf(answerMatch[1].toUpperCase());
                            if (correctIndex >= 0) {
                                currentQuestion.correct = correctIndex;
                                console.log(`Set correct answer: ${answerMatch[1]} (index ${correctIndex})`);
                            }
                        }
                    }
                }
                
                // Add the last question if it's valid
                if (currentQuestion && currentQuestion.options.length >= 2) {
                    extractedQuestions.push(currentQuestion);
                    console.log('Added final question:', currentQuestion);
                }
                
                console.log('All extracted questions:', extractedQuestions);
                
                if (extractedQuestions.length > 0) {
                    quizQuestions = extractedQuestions;
                    console.log('Successfully parsed quiz questions:', quizQuestions);
                    displayQuiz();
                    return;
                } else {
                    console.error('No valid questions extracted from content');
                    console.log('Final error details:');
                    console.log('- Content received:', content);
                    console.log('- Content length:', content ? content.length : 'undefined');
                    console.log('- Content preview:', content ? content.substring(0, 200) + '...' : 'undefined');
                    alert('Failed to generate quiz questions. The AI response could not be parsed. Please check your API key and try again, or ensure your transcript has sufficient content. Check the console (F12) for detailed error information.');
                    return;
                }
            } catch (error) {
                console.error('Error generating quiz:', error);
                alert(`Error generating quiz: ${error.message}. Please check your API key and try again.`);
            }
        }

        function displayQuiz() {
            console.log('=== DISPLAYING QUIZ ===');
            const container = document.getElementById('quizContainer');
            const display = document.getElementById('quizDisplay');
            
            console.log('Quiz container:', container);
            console.log('Quiz display:', display);
            console.log('Number of quiz questions:', quizQuestions.length);
            
            currentQuestionIndex = 0;
            showCurrentQuestion();
        }

        function showCurrentQuestion() {
            if (quizQuestions.length === 0) return;
            
            const question = quizQuestions[currentQuestionIndex];
            const display = document.getElementById('quizDisplay');
            
            display.innerHTML = `
                <div class="mcq-question">
                    <h5>${question.question}</h5>
                    ${question.options.map((option, index) => `
                        <button class="mcq-option" onclick="selectAnswer(${index})">
                            ${String.fromCharCode(65 + index)}) ${option}
                        </button>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('questionCounter').textContent = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
        }

        function selectAnswer(selectedIndex) {
            const question = quizQuestions[currentQuestionIndex];
            const buttons = document.querySelectorAll('.mcq-option');
            
            buttons.forEach((button, index) => {
                if (index === question.correct) {
                    button.style.backgroundColor = '#28a745';
                    button.style.color = 'white';
                } else if (index === selectedIndex && selectedIndex !== question.correct) {
                    button.style.backgroundColor = '#dc3545';
                    button.style.color = 'white';
                } else {
                    button.style.backgroundColor = '#6c757d';
                    button.style.color = 'white';
                }
                button.disabled = true;
            });
            
            setTimeout(() => {
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++;
                    showCurrentQuestion();
                }
            }, 2000);
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                showCurrentQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showCurrentQuestion();
            }
        }

        // Summary Generation
        async function generateSummary() {
            console.log('=== GENERATE SUMMARY STARTED ===');
            
            // Check if required elements exist
            const studyMaterials = document.getElementById('studyMaterials');
            const transcriptContent = document.getElementById('transcriptContent');
            
            if (!studyMaterials || !transcriptContent) {
                console.error('Required summary elements not found:', {
                    studyMaterials: !!studyMaterials,
                    transcriptContent: !!transcriptContent
                });
                alert('Error: Required summary elements not found. Please refresh the page and try again.');
                return;
            }
            
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                return;
            }

            const transcript = document.getElementById('transcriptContent').textContent;
            console.log('Summary generation - Transcript length:', transcript.length);
            
            // Check if transcript has meaningful content
            if (!transcript || transcript.trim().length < 50) {
                alert('Please load a transcript first. The current transcript is too short or empty.');
                return;
            }
            
            console.log('Generating summary for transcript length:', transcript.length);
            
            try {
                console.log('Making summary API request to OpenAI...');
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'system',
                            content: 'Create a concise summary of the key points from the transcript.'
                        }, {
                            role: 'user',
                            content: transcript
                        }],
                        temperature: 0.7
                    })
                });

                console.log('Summary API response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Summary API Error response:', errorData);
                    throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log('Summary API response:', data);
                
                const summary = data.choices[0].message.content;
                console.log('Summary generated:', summary);
                
                displayStudyMaterials('Summary', summary);
            } catch (error) {
                console.error('Error generating summary:', error);
                alert(`Error generating summary: ${error.message}. Please check your API key and try again.`);
            }
        }

        // Study Guide Generation
        async function generateStudyGuide() {
            console.log('=== GENERATE STUDY GUIDE STARTED ===');
            
            // Check if required elements exist
            const studyMaterials = document.getElementById('studyMaterials');
            const transcriptContent = document.getElementById('transcriptContent');
            
            if (!studyMaterials || !transcriptContent) {
                console.error('Required study guide elements not found:', {
                    studyMaterials: !!studyMaterials,
                    transcriptContent: !!transcriptContent
                });
                alert('Error: Required study guide elements not found. Please refresh the page and try again.');
                return;
            }
            
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                return;
            }

            const transcript = document.getElementById('transcriptContent').textContent;
            console.log('Study guide generation - Transcript length:', transcript.length);
            
            // Check if transcript has meaningful content
            if (!transcript || transcript.trim().length < 50) {
                alert('Please load a transcript first. The current transcript is too short or empty.');
                return;
            }
            
            console.log('Generating study guide for transcript length:', transcript.length);
            
            // Reset flashcard state when switching to study guide
            resetFlashcardState();
            
            try {
                console.log('Making study guide API request to OpenAI...');
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'system',
                            content: 'Create a comprehensive study guide with step-by-step instructions, key concepts, and practice tips based on the transcript.'
                        }, {
                            role: 'user',
                            content: transcript
                        }],
                        temperature: 0.7
                    })
                });

                console.log('Study guide API response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Study guide API Error response:', errorData);
                    throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log('Study guide API response:', data);
                
                const studyGuide = data.choices[0].message.content;
                console.log('Study guide generated successfully');
                
                displayStudyMaterials('Study Guide', studyGuide);
            } catch (error) {
                console.error('Error generating study guide:', error);
                alert(`Error generating study guide: ${error.message}. Please check your API key and try again.`);
            }
        }

        function displayStudyMaterials(title, content) {
            console.log('=== DISPLAYING STUDY MATERIALS ===');
            console.log('Title:', title);
            console.log('Content length:', content.length);
            
            const container = document.getElementById('studyMaterials');
            const materialsContent = document.getElementById('materialsContent');
            
            console.log('Study materials container:', container);
            console.log('Materials content:', materialsContent);
            
            // Check if elements exist before proceeding
            if (!container) {
                console.error('studyMaterials container not found!');
                alert('Error: Study materials container not found. Please refresh the page.');
                return;
            }
            
            if (!materialsContent) {
                console.error('materialsContent not found!');
                alert('Error: Materials content not found. Please refresh the page.');
                return;
            }
            
            container.style.display = 'block';
            
            const flashcardsContainer = document.getElementById('flashcardsContainer');
            const quizContainer = document.getElementById('quizContainer');
            
            if (flashcardsContainer) flashcardsContainer.style.display = 'none';
            if (quizContainer) quizContainer.style.display = 'none';
            
            // Reset flashcard state when switching to study materials
            resetFlashcardState();
            
            // Convert markdown-like content to HTML
            let htmlContent = content
                .replace(/^##\s*(.*?)$/gm, '<h3>$1</h3>')  // Convert ## headers to h3
                .replace(/^#\s*(.*?)$/gm, '<h2>$1</h2>')   // Convert # headers to h2
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Additional cleanup for any remaining ## or # that might be in the middle of text
            htmlContent = htmlContent
                .replace(/##\s*(.*?)(?=\n|$)/g, '<h3>$1</h3>')
                .replace(/#\s*(.*?)(?=\n|$)/g, '<h2>$1</h2>')
                // Final cleanup for any remaining ## symbols anywhere in the text
                .replace(/##/g, '')
                .replace(/\s*#\s*(?=\w)/g, ' '); // Remove single # followed by word
            
            // Wrap in paragraph tags if not already wrapped
            if (!htmlContent.startsWith('<h') && !htmlContent.startsWith('<p')) {
                htmlContent = '<p>' + htmlContent + '</p>';
            }
            
            // Double-check materialsContent exists before setting innerHTML
            if (materialsContent) {
                materialsContent.innerHTML = `
                    <h4>${title}</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        ${htmlContent}
                    </div>
                `;
                console.log('Study materials displayed successfully');
            } else {
                console.error('materialsContent is null when trying to set innerHTML!');
                alert('Error: Could not display study materials. Please refresh the page.');
            }
        }

        // Event listeners
        document.getElementById('transcriptContent').addEventListener('scroll', function() {
            updateProgress();
            updateReadingGuidePosition();
        });

        // Initialize achievements
        achievements = JSON.parse(localStorage.getItem('achievements') || '[]');

        // Test function to force display options
        function testMCQDisplay() {
            console.log('Testing MCQ display...');
            const display = document.getElementById('quizDisplay');
            if (display) {
                display.innerHTML = `
                    <div class="mcq-question">
                        <h5>Test Question: What does FOIL stand for?</h5>
                        <button class="mcq-option" onclick="alert('Option A clicked')">First, Outer, Inner, Last</button>
                        <button class="mcq-option" onclick="alert('Option B clicked')">Fast, Organized, Intelligent, Learning</button>
                        <button class="mcq-option" onclick="alert('Option C clicked')">Form, Order, Input, Logic</button>
                        <button class="mcq-option" onclick="alert('Option D clicked')">Function, Output, Input, Logic</button>
                    </div>
                `;
                console.log('Test MCQ displayed');
            } else {
                console.log('Quiz display element not found');
            }
        }

        // Force apply high contrast styles
        function forceHighContrast() {
            console.log('Forcing high contrast styles...');
            changeTheme('high-contrast');
        }

        // Test function to manually fix question visibility
        function fixQuestionVisibility() {
            console.log('Manually fixing question visibility...');
            
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('background-color', '#111111', 'important');
                element.style.setProperty('font-weight', 'bold', 'important');
            });
            
            console.log('Question visibility fixed');
        }

        // Test AI API connection
        async function testAIConnection() {
            console.log('Testing AI API connection...');
            
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'user',
                            content: 'Say "API test successful" if you can read this.'
                        }],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API test successful:', data);
                    alert('✅ API connection successful! The AI features should work now.');
                } else {
                    const errorData = await response.json();
                    console.error('API test failed:', errorData);
                    alert(`❌ API test failed: ${errorData.error?.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('API test error:', error);
                alert(`❌ API test error: ${error.message}`);
            }
        }

        // Quick diagnostic function
        function quickDiagnostic() {
            console.log('=== QUICK DIAGNOSTIC ===');
            
            const transcript = document.getElementById('transcriptContent');
            const apiKey = document.getElementById('apiKey');
            
            let diagnostic = '🔍 QUICK DIAGNOSTIC:\n\n';
            
            // Check transcript
            if (transcript && transcript.textContent.length > 50) {
                diagnostic += `✅ Transcript loaded (${transcript.textContent.length} chars)\n`;
            } else {
                diagnostic += '❌ No transcript found\n';
            }
            
            // Check API key
            if (apiKey && apiKey.value.length > 0) {
                diagnostic += `✅ API key entered (${apiKey.value.length} chars)\n`;
            } else {
                diagnostic += '❌ No API key entered\n';
            }
            
            // Check if buttons exist
            const buttons = ['Generate Flashcards', 'Generate Quiz', 'Generate Summary', 'Generate Study Guide'];
            let missingButtons = [];
            
            buttons.forEach(buttonText => {
                const button = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes(buttonText));
                if (!button) {
                    missingButtons.push(buttonText);
                }
            });
            
            if (missingButtons.length === 0) {
                diagnostic += '✅ All AI buttons found\n';
            } else {
                diagnostic += `❌ Missing buttons: ${missingButtons.join(', ')}\n`;
            }
            
            diagnostic += '\n💡 If everything shows ✅, try clicking the AI buttons now!';
            
            alert(diagnostic);
        }

        // Force display quiz container and test options
        function forceQuizDisplay() {
            console.log('Forcing quiz display...');
            
            // Show quiz container
            const container = document.getElementById('quizContainer');
            container.style.display = 'block';
            
            // Hide other containers
            document.getElementById('flashcardsContainer').style.display = 'none';
            document.getElementById('studyMaterials').style.display = 'none';
            
            // Force display test options
            const display = document.getElementById('quizDisplay');
            display.innerHTML = `
                <div class="mcq-question">
                    <h5>FORCED TEST: What does FOIL stand for?</h5>
                    <button class="mcq-option" style="display: block; width: 100%; margin: 10px 0; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="alert('A clicked')">
                        A) First, Outer, Inner, Last
                    </button>
                    <button class="mcq-option" style="display: block; width: 100%; margin: 10px 0; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="alert('B clicked')">
                        B) Fast, Organized, Intelligent, Learning
                    </button>
                    <button class="mcq-option" style="display: block; width: 100%; margin: 10px 0; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="alert('C clicked')">
                        C) Form, Order, Input, Logic
                    </button>
                    <button class="mcq-option" style="display: block; width: 100%; margin: 10px 0; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="alert('D clicked')">
                        D) Function, Output, Input, Logic
                    </button>
                </div>
            `;
            
            console.log('Forced quiz display completed');
        }

        // Simple test function that actually works
        function testAllFeatures() {
            console.log('=== SIMPLE FEATURE TEST ===');
            
            // Check transcript
            const transcript = document.getElementById('transcriptContent');
            const hasTranscript = transcript && transcript.textContent.length > 50;
            
            // Check API key
            const apiKey = document.getElementById('apiKey');
            const hasApiKey = apiKey && apiKey.value.length > 0;
            
            // Check if AI buttons exist
            const buttons = {
                flashcards: document.querySelector('button[onclick="generateFlashcards()"]'),
                quiz: document.querySelector('button[onclick="generateQuiz()"]'),
                summary: document.querySelector('button[onclick="generateSummary()"]'),
                studyGuide: document.querySelector('button[onclick="generateStudyGuide()"]')
            };
            
            const allButtonsExist = Object.values(buttons).every(btn => btn !== null);
            
            // Simple summary
            let summary = '🔧 FEATURE TEST RESULTS:\n\n';
            
            if (hasTranscript) {
                summary += `✅ Transcript loaded (${transcript.textContent.length} chars)\n`;
            } else {
                summary += '❌ No transcript found\n';
            }
            
            if (hasApiKey) {
                summary += `✅ API key entered (${apiKey.value.length} chars)\n`;
            } else {
                summary += '❌ No API key entered\n';
            }
            
            if (allButtonsExist) {
                summary += '✅ All AI buttons found\n';
            } else {
                summary += '❌ Some AI buttons missing\n';
            }
            
            summary += '\n💡 If everything shows ✅, try clicking the AI buttons now!';
            
            alert(summary);
        }

        // Add test button to the page
        function addTestButton() {
            const testBtn = document.createElement('button');
            testBtn.textContent = '🔧 Test All Features';
            testBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 10000; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;';
            testBtn.onclick = testAllFeatures;
            document.body.appendChild(testBtn);
            
            const apiTestBtn = document.createElement('button');
            apiTestBtn.textContent = '🤖 Test AI API';
            apiTestBtn.style.cssText = 'position: fixed; top: 50px; right: 10px; z-index: 10000; background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;';
            apiTestBtn.onclick = testAIConnection;
            document.body.appendChild(apiTestBtn);
            
            const quickDiagBtn = document.createElement('button');
            quickDiagBtn.textContent = '🔍 Quick Check';
            quickDiagBtn.style.cssText = 'position: fixed; top: 90px; right: 10px; z-index: 10000; background: #ffc107; color: black; border: none; padding: 10px; border-radius: 5px; cursor: pointer;';
            quickDiagBtn.onclick = quickDiagnostic;
            document.body.appendChild(quickDiagBtn);
            
            const elementTestBtn = document.createElement('button');
            elementTestBtn.textContent = '🧩 Test Elements';
            elementTestBtn.style.cssText = 'position: fixed; top: 130px; right: 10px; z-index: 10000; background: #6f42c1; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;';
            elementTestBtn.onclick = testElementAccess;
            document.body.appendChild(elementTestBtn);
            
            console.log('Test buttons added to page');
        }

        // Initialize page when it loads
        window.addEventListener('load', function() {
            // Don't automatically load default transcript - let user choose
            // loadDefaultTranscript();
            
            // Add test buttons after a delay
            setTimeout(addTestButton, 1000);
            
            console.log('Page initialized - user can load transcript manually');
        });

        // Simple test function for AI generation
        function testAIGeneration() {
            console.log('=== TESTING AI GENERATION ===');
            
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('❌ Please enter your OpenAI API key first!');
                return;
            }
            
            const transcript = document.getElementById('transcriptContent').textContent;
            if (!transcript || transcript.trim().length < 50) {
                alert('❌ Please load a transcript first! Current length: ' + (transcript ? transcript.length : 0));
                return;
            }
            
            // Show a test message
            const testDiv = document.createElement('div');
            testDiv.id = 'aiTestMessage';
            testDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: green; color: white; padding: 20px; border-radius: 10px; z-index: 10000; font-size: 18px; text-align: center;';
            testDiv.innerHTML = '🤖 Testing AI Generation...<br><br>Check console for details';
            document.body.appendChild(testDiv);
            
            // Test with a simple API call
            fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [{
                        role: 'system',
                        content: 'You are a helpful assistant. Respond with "AI is working!" if you receive this message.'
                    }, {
                        role: 'user',
                        content: 'Test message'
                    }],
                    max_tokens: 10
                })
            })
            .then(response => {
                console.log('Test API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Test API response:', data);
                testDiv.innerHTML = '✅ AI is working!<br><br>Response: ' + data.choices[0].message.content;
                testDiv.style.background = 'green';
                setTimeout(() => {
                    if (testDiv.parentNode) {
                        testDiv.parentNode.removeChild(testDiv);
                    }
                }, 3000);
            })
            .catch(error => {
                console.error('Test API error:', error);
                testDiv.innerHTML = '❌ AI test failed<br><br>Error: ' + error.message;
                testDiv.style.background = 'red';
                setTimeout(() => {
                    if (testDiv.parentNode) {
                        testDiv.parentNode.removeChild(testDiv);
                    }
                }, 5000);
            });
        }

        // Add test AI button to the page
        function addTestAIButton() {
            const testAIBtn = document.createElement('button');
            testAIBtn.textContent = '🤖 Test AI';
            testAIBtn.style.cssText = 'position: fixed; top: 50px; right: 10px; z-index: 10000; background: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;';
            testAIBtn.onclick = testAIGeneration;
            document.body.appendChild(testAIBtn);
            console.log('Test AI button added to page');
        }

        // Test function to check element accessibility
        function testElementAccess() {
            console.log('=== TESTING ELEMENT ACCESS ===');
            console.log('document.readyState:', document.readyState);
            console.log('document.body exists:', !!document.body);
            
            const elements = ['flashcardsContainer', 'flashcardDisplay', 'cardCounter', 'transcriptContent'];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}:`, element ? 'Found' : 'MISSING!');
                if (element) {
                    console.log(`  - tagName: ${element.tagName}`);
                    console.log(`  - id: ${element.id}`);
                    console.log(`  - display: ${window.getComputedStyle(element).display}`);
                    console.log(`  - parentElement: ${element.parentElement ? element.parentElement.id : 'No parent'}`);
                }
            });
            
            // Try alternative selectors
            console.log('=== ALTERNATIVE SELECTORS ===');
            const allDivs = document.querySelectorAll('div');
            console.log('Total divs:', allDivs.length);
            
            const divsWithId = Array.from(allDivs).filter(div => div.id);
            console.log('Divs with IDs:', divsWithId.map(div => div.id));
            
            // Check if elements exist by tag name and content
            const flashcardDivs = document.querySelectorAll('div[id*="flashcard"]');
            console.log('Flashcard-related divs:', flashcardDivs.length);
            flashcardDivs.forEach(div => console.log('  -', div.id));
        }

        // Make the test function globally accessible
        window.testElementAccess = testElementAccess;

        // Add immediate test button with better timing
        function addImmediateTestButton() {
            const testButton = document.createElement('button');
            testButton.textContent = '🔍 Test Elements Now';
            testButton.style.cssText = 'position: fixed; top: 10px; left: 10px; z-index: 10000; background: #ff4444; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;';
            testButton.onclick = function() {
                // Wait a bit to ensure DOM is ready
                setTimeout(() => {
                    const result = enhancedElementTest();
                    if (result) {
                        alert('✅ All elements found! You can now use the AI features.');
                    } else {
                        alert('❌ Some elements missing! Please refresh the page and try again. Check the console (F12) for details.');
                    }
                }, 100);
            };
            document.body.appendChild(testButton);
        }

        // Enhanced element test with retry mechanism
        function enhancedElementTest() {
            console.log('=== ENHANCED ELEMENT TEST ===');
            console.log('document.readyState:', document.readyState);
            console.log('document.body exists:', !!document.body);
            
            const elements = ['flashcardsContainer', 'flashcardDisplay', 'cardCounter', 'transcriptContent'];
            let allFound = true;
            let missingElements = [];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}:`, element ? 'Found' : 'MISSING!');
                if (!element) {
                    allFound = false;
                    missingElements.push(id);
                } else {
                    console.log(`  - ${id} tagName: ${element.tagName}`);
                    console.log(`  - ${id} id: ${element.id}`);
                    console.log(`  - ${id} display: ${window.getComputedStyle(element).display}`);
                }
            });
            
            if (allFound) {
                console.log('✅ All elements found!');
                return true;
            } else {
                console.log('❌ Missing elements:', missingElements);
                return false;
            }
        }

        // Call this with proper timing
        function initializeTestButton() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', addImmediateTestButton);
            } else {
                // DOM is already loaded
                setTimeout(addImmediateTestButton, 100);
            }
        }

        // Initialize the test button - commented out since we fixed the issue
        // initializeTestButton();

        function resetFlashcardState() {
            // Reset flashcard state when switching to other features
            currentCardIndex = 0;
            const display = document.getElementById('flashcardDisplay');
            if (display) {
                display.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Click "Generate Flashcards" to create flashcards from your transcript.</div>';
            }
        }

        // Test function to verify flashcard parsing
        function testFlashcardParsing() {
            console.log('=== TESTING FLASHCARD PARSING ===');
            const testContent = `Question: What does FOIL stand for?
Answer: First, Outer, Inner, Last

Question: What is the first step in FOIL method?
Answer: Multiply the first terms of each binomial

Question: What do you multiply in the outer step?
Answer: Multiply the outer terms of the binomials`;

            // Use the same parsing logic as the main function
            const questionBlocks = testContent.split(/Question:\s*/).filter(block => block.trim());
            
            const testFlashcards = questionBlocks.map((block, index) => {
                if (!block.includes('Answer:')) {
                    console.warn('Block missing Answer:', block);
                    return null;
                }
                
                const parts = block.split(/Answer:\s*/);
                if (parts.length < 2) {
                    console.warn('Invalid block format:', block);
                    return null;
                }
                
                let question = parts[0].trim();
                let answer = parts[1].trim();
                
                if (!question || !answer) {
                    console.warn('Empty question or answer:', { question, answer });
                    return null;
                }
                
                // Apply the same simple and conservative smart detection logic
                const questionEndsWithQuestionMark = question.endsWith('?');
                const answerEndsWithQuestionMark = answer.endsWith('?');
                
                // Check for common question words in the "question" part
                const questionWords = ['what', 'when', 'where', 'why', 'how', 'which', 'who', 'whose', 'whom'];
                const questionLower = question.toLowerCase();
                const hasQuestionWords = questionWords.some(word => questionLower.includes(word));
                
                // Check for common answer indicators in the "answer" part
                const answerIndicators = ['is', 'are', 'was', 'were', 'will', 'would', 'could', 'should', 'can', 'may', 'might', 'the', 'a', 'an'];
                const answerLower = answer.toLowerCase();
                const hasAnswerIndicators = answerIndicators.some(word => answerLower.startsWith(word));
                
                console.log(`Test card ${index} analysis:`, {
                    questionEndsWithQuestionMark,
                    answerEndsWithQuestionMark,
                    hasQuestionWords,
                    hasAnswerIndicators,
                    question: question.substring(0, 50) + (question.length > 50 ? '...' : ''),
                    answer: answer.substring(0, 50) + (answer.length > 50 ? '...' : '')
                });
                
                // Conservative detection logic - only swap when clearly inverted
                let shouldSwap = false;
                
                // Case 1: Clear question mark mismatch - answer has ? but question doesn't
                if (!questionEndsWithQuestionMark && answerEndsWithQuestionMark) {
                    shouldSwap = true;
                    console.log(`Test card ${index}: Detected inversion by question mark - swapping Q&A`);
                }
                // Case 2: Answer starts with question words - definitely inverted
                else if (questionWords.some(word => answerLower.startsWith(word))) {
                    shouldSwap = true;
                    console.log(`Test card ${index}: Detected inversion by answer starting with question word - swapping Q&A`);
                }
                // Case 3: Question has answer indicators and answer has question words - likely inverted
                else if (hasAnswerIndicators && questionWords.some(word => answerLower.includes(word))) {
                    shouldSwap = true;
                    console.log(`Test card ${index}: Detected inversion by mixed indicators - swapping Q&A`);
                }
                
                if (shouldSwap) {
                    [question, answer] = [answer, question];
                }
                
                return { question, answer };
            }).filter(card => card !== null);
            
            console.log('Test flashcards parsed:', testFlashcards);
            console.log('First card - Question:', testFlashcards[0]?.question);
            console.log('First card - Answer:', testFlashcards[0]?.answer);
        }



        // Test AI API connection
    </script>
</body>
</html> 