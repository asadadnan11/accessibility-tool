<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Enhanced Learning Accessibility Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            transition: all 0.3s ease;
        }

        /* Multiple Color Themes */
        body.theme-yellow-black {
            background: #000;
            color: #ffff00;
        }

        body.theme-blue-white {
            background: #000080;
            color: #ffffff;
        }

        body.theme-blue-white .transcript-section,
        body.theme-blue-white .ai-section,
        body.theme-blue-white .enhanced-controls,
        body.theme-blue-white .mcq-question {
            background: #000080 !important;
            color: #ffffff !important;
        }

        body.theme-blue-white .mcq-question h5,
        body.theme-blue-white .mcq-question p,
        body.theme-blue-white .mcq-question div {
            color: #ffffff !important;
            background: #000080 !important;
        }

        body.theme-green-black {
            background: #000;
            color: #00ff00;
        }

        body.theme-high-contrast {
            background: #000;
            color: #fff;
        }

        /* Focus Mode */
        body.focus-mode {
            background: #1a1a1a;
            color: #ffffff;
        }

        body.focus-mode .controls,
        body.focus-mode .sidebar {
            display: none !important;
        }

        /* Keep header visible in focus mode but style it properly */
        body.focus-mode .header {
            background: #1a1a1a !important;
            color: #ffffff !important;
        }

        body.focus-mode .header h1,
        body.focus-mode .header p {
            color: #ffffff !important;
        }

        body.focus-mode .main-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Focus mode text visibility fixes */
        body.focus-mode .transcript-content,
        body.focus-mode .mcq-question,
        body.focus-mode .mcq-question h5,
        body.focus-mode .mcq-question p,
        body.focus-mode .mcq-question div,
        body.focus-mode .mcq-question span {
            color: #ffffff !important;
            background: #1a1a1a !important;
        }

        body.focus-mode .transcript-section,
        body.focus-mode .ai-section {
            background: #1a1a1a !important;
            color: #ffffff !important;
        }

        body.focus-mode .mcq-option {
            background: #333333 !important;
            color: #ffffff !important;
            border-color: #ffffff !important;
        }

        body.focus-mode .mcq-option:hover {
            background: #444444 !important;
            color: #ffffff !important;
        }

        body.focus-mode .mcq-option.selected {
            background: #555555 !important;
            color: #ffffff !important;
        }

        body.focus-mode .mcq-option.correct {
            background: #006400 !important;
            color: #ffffff !important;
        }

        body.focus-mode .mcq-option.incorrect {
            background: #8b0000 !important;
            color: #ffffff !important;
        }

        /* Reading Guide */
        .reading-guide {
            position: fixed;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 0, 0.3);
            z-index: 1000;
            pointer-events: none;
            transition: top 0.3s ease;
            display: none;
        }

        .reading-guide.active {
            background: rgba(255, 255, 0, 0.8);
        }

        /* Progress Tracking */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: #4CAF50;
            z-index: 1001;
            transition: width 0.3s ease;
        }

        .session-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1002;
        }

        /* Enhanced Controls */
        .enhanced-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .control-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #007bff;
            color: white;
        }

        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #6c757d;
        }

        button.success {
            background: #28a745;
        }

        button.warning {
            background: #ffc107;
            color: #212529;
        }

        button.danger {
            background: #dc3545;
        }

        /* Main Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .transcript-section, .ai-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .transcript-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            line-height: 1.8;
            font-size: 16px;
        }

        /* Step Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .step-indicator {
            font-weight: bold;
            color: #007bff;
        }

        /* Enhanced TTS Controls */
        .tts-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .voice-selector {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Interactive Elements */
        .flashcard {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .flashcard:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }

        .flashcard.flipped {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .mcq-question {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .mcq-option {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }

        .mcq-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
            color: #333;
        }

        .mcq-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
            color: #333;
        }

        .mcq-option.correct {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .mcq-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .mcq-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .mcq-feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .mcq-feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Notes Section */
        .notes-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }

        /* Achievement System */
        .achievements {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            max-width: 300px;
            z-index: 1003;
        }

        .achievement {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .achievement-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .step-navigation {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* High Contrast Theme Enhancements */
        body.high-contrast .transcript-content,
        body.high-contrast .flashcard,
        body.high-contrast .mcq-question,
        body.high-contrast .mcq-option,
        body.high-contrast .enhanced-controls,
        body.high-contrast .transcript-section,
        body.high-contrast .ai-section {
            background: #111;
            color: #fff;
            border-color: #fff;
        }

        body.high-contrast .mcq-option:hover {
            background: #333;
            border-color: #fff;
        }

        body.high-contrast .mcq-option.selected {
            background: #444;
            border-color: #fff;
        }

        body.high-contrast .mcq-option.correct {
            background: #006400;
            border-color: #00ff00;
            color: #fff;
        }

        body.high-contrast .mcq-option.incorrect {
            background: #8b0000;
            border-color: #ff0000;
            color: #fff;
        }

        body.high-contrast .mcq-feedback {
            background: #111;
            border-color: #fff;
            color: #fff;
        }

        body.high-contrast .mcq-feedback.correct {
            background: #006400;
            border-color: #00ff00;
            color: #fff;
        }

        body.high-contrast .mcq-feedback.incorrect {
            background: #8b0000;
            border-color: #ff0000;
            color: #fff;
        }

        body.high-contrast .flashcard.flipped {
            background: #333;
            color: #fff;
        }

        body.high-contrast .step-navigation {
            background: #333;
            color: #fff;
        }

        body.high-contrast .notes-section {
            background: #333;
            border-color: #fff;
            color: #fff;
        }

        body.high-contrast .achievements {
            background: #111;
            color: #fff;
        }

        body.high-contrast .achievement {
            background: #333;
            color: #fff;
        }

        /* Fix for question text visibility in high contrast */
        body.high-contrast .mcq-question h5 {
            color: #fff !important;
            background: #111 !important;
        }

        body.high-contrast .mcq-question p {
            color: #fff !important;
            background: #111 !important;
        }

        body.high-contrast .mcq-question div {
            color: #fff !important;
            background: #111 !important;
        }

        /* Force all text to be white in high contrast */
        body.high-contrast * {
            color: #fff !important;
        }

        /* Override any theme colors in high contrast */
        body.high-contrast.theme-yellow-black *,
        body.high-contrast.theme-blue-white *,
        body.high-contrast.theme-green-black * {
            color: #fff !important;
        }

        /* Specific overrides for question elements */
        body.high-contrast .mcq-question,
        body.high-contrast .mcq-question *,
        body.high-contrast .mcq-question h5,
        body.high-contrast .mcq-question p,
        body.high-contrast .mcq-question span,
        body.high-contrast .mcq-question div {
            color: #fff !important;
            background: #111 !important;
        }

        /* Ensure all headings are white */
        body.high-contrast h1,
        body.high-contrast h2,
        body.high-contrast h3,
        body.high-contrast h4,
        body.high-contrast h5,
        body.high-contrast h6 {
            color: #fff !important;
        }

        /* Ensure all text elements are white */
        body.high-contrast p,
        body.high-contrast span,
        body.high-contrast div,
        body.high-contrast label {
            color: #fff !important;
        }

        /* Ensure header is always visible in all themes */
        body.high-contrast .header,
        body.theme-yellow-black .header,
        body.theme-blue-white .header,
        body.theme-green-black .header,
        body.focus-mode .header {
            display: block !important;
            visibility: visible !important;
        }

        body.high-contrast .header h1,
        body.high-contrast .header p,
        body.theme-yellow-black .header h1,
        body.theme-yellow-black .header p,
        body.theme-blue-white .header h1,
        body.theme-blue-white .header p,
        body.theme-green-black .header h1,
        body.theme-green-black .header p,
        body.focus-mode .header h1,
        body.focus-mode .header p {
            color: inherit !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <!-- Progress Bar -->
    <div class="progress-bar" id="progressBar"></div>
    
    <!-- Session Info -->
    <div class="session-info" id="sessionInfo">
        <div>Session: <span id="sessionTime">00:00</span></div>
        <div>Progress: <span id="progressPercent">0%</span></div>
    </div>

    <!-- Reading Guide -->
    <div class="reading-guide" id="readingGuide"></div>

    <div class="container">
        <div class="header">
            <h1>AI-Enhanced Learning Accessibility Tool</h1>
            <p>Optimized for Neurodivergent and ESL Students</p>
        </div>

        <!-- Enhanced Controls -->
        <div class="enhanced-controls">
            <div class="control-group">
                <h4>üéØ Focus & Navigation</h4>
                <div class="control-buttons">
                    <button onclick="toggleFocusMode()" id="focusBtn">Focus Mode</button>
                    <button onclick="toggleReadingGuide()" id="guideBtn">Reading Guide</button>
                    <button onclick="resetProgress()">Reset Progress</button>
                    <button onclick="fullscreenMode()">Fullscreen</button>
                </div>
            </div>

            <div class="control-group">
                <h4>üé® Visual Accessibility</h4>
                <div class="control-buttons">
                    <button onclick="changeTheme('default')">Default</button>
                    <button onclick="changeTheme('yellow-black')">Yellow/Black</button>
                    <button onclick="changeTheme('blue-white')">Blue/White</button>
                    <button onclick="changeTheme('green-black')">Green/Black</button>
                    <button onclick="changeTheme('high-contrast')">High Contrast</button>
                </div>
                <div style="margin-top: 10px;">
                    <label>Font Size: </label>
                    <button onclick="changeFontSize(14)">Small</button>
                    <button onclick="changeFontSize(16)">Medium</button>
                    <button onclick="changeFontSize(18)">Large</button>
                    <button onclick="changeFontSize(20)">Extra Large</button>
                </div>
                <div style="margin-top: 10px;">
                    <label>Line Spacing: </label>
                    <button onclick="changeLineSpacing('1.2')">Tight</button>
                    <button onclick="changeLineSpacing('1.6')">Normal</button>
                    <button onclick="changeLineSpacing('2.0')">Loose</button>
                    <button onclick="changeLineSpacing('2.5')">Very Loose</button>
                </div>
            </div>

            <div class="control-group">
                <h4>üîä Enhanced Text-to-Speech</h4>
                <div class="tts-controls">
                    <button onclick="toggleReadAloud()" id="readAloudBtn">Read Aloud</button>
                    <button onclick="stopReading()">Stop</button>
                    <button onclick="pauseReading()">Pause</button>
                    <button onclick="resumeReading()">Resume</button>
                    <select id="voiceSelect" class="voice-selector">
                        <option value="">Select Voice</option>
                    </select>
                    <select id="speedSelect" class="voice-selector">
                        <option value="0.5">Very Slow</option>
                        <option value="0.8">Slow</option>
                        <option value="1.0" selected>Normal</option>
                        <option value="1.2">Fast</option>
                        <option value="1.5">Very Fast</option>
                    </select>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="translateToSpanish()">Translate to Spanish</button>
                    <button onclick="translateToFrench()">Translate to French</button>
                    <button onclick="translateToGerman()">Translate to German</button>
                    <button onclick="resetTranslation()">Reset to English</button>
                </div>
            </div>

            <div class="control-group">
                <h4>üìö Learning Tools</h4>
                <div class="control-buttons">
                    <button onclick="generateFlashcards()">Generate Flashcards</button>
                    <button onclick="generateQuiz()">Generate Quiz</button>
                    <button onclick="generateSummary()">Generate Summary</button>
                    <button onclick="generateStudyGuide()">Generate Study Guide</button>
                    <button onclick="toggleNotes()" id="notesBtn">Show Notes</button>
                </div>
            </div>
        </div>

        <!-- Step Navigation -->
        <div class="step-navigation">
            <button onclick="previousSection()" id="prevBtn">‚Üê Previous</button>
            <div class="step-indicator">Section <span id="currentSection">1</span> of <span id="totalSections">1</span></div>
            <button onclick="nextSection()" id="nextBtn">Next ‚Üí</button>
        </div>

        <div class="main-content">
            <div class="transcript-section">
                <h3>Lecture Transcript</h3>
                <div class="transcript-content" id="transcriptContent">
                    The FOIL method is a technique used to multiply two binomials. FOIL stands for First, Outer, Inner, Last. Let's break this down step by step.

                    When you have two binomials like (a + b) and (c + d), you multiply them using the FOIL method:
                    
                    First: Multiply the first terms of each binomial (a √ó c)
                    Outer: Multiply the outer terms (a √ó d)
                    Inner: Multiply the inner terms (b √ó c)
                    Last: Multiply the last terms of each binomial (b √ó d)
                    
                    Then you add all these products together: ac + ad + bc + bd
                    
                    Let's work through an example: (x + 3)(x + 2)
                    
                    First: x √ó x = x¬≤
                    Outer: x √ó 2 = 2x
                    Inner: 3 √ó x = 3x
                    Last: 3 √ó 2 = 6
                    
                    Adding them together: x¬≤ + 2x + 3x + 6 = x¬≤ + 5x + 6
                    
                    This method helps you remember to multiply every term in the first binomial by every term in the second binomial, ensuring you don't miss any combinations.
                </div>
            </div>

            <div class="ai-section">
                <h3>AI Learning Assistant</h3>
                
                <!-- API Key Section -->
                <div class="api-key-section" style="margin-bottom: 20px;">
                    <label for="apiKey">OpenAI API Key:</label>
                    <input type="password" id="apiKey" placeholder="Enter your OpenAI API key" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <!-- Interactive Flashcards -->
                <div id="flashcardsContainer" style="display: none;">
                    <h4>Interactive Flashcards</h4>
                    <div id="flashcardDisplay"></div>
                    <div style="margin-top: 10px;">
                        <button onclick="previousCard()" id="prevCardBtn">‚Üê Previous</button>
                        <span id="cardCounter" style="margin: 0 10px;">Card 1 of 1</span>
                        <button onclick="nextCard()" id="nextCardBtn">Next ‚Üí</button>
                    </div>
                </div>

                <!-- Interactive Quiz -->
                <div id="quizContainer" style="display: none;">
                    <h4>Interactive Quiz</h4>
                    <div id="quizDisplay"></div>
                    <div style="margin-top: 10px;">
                        <button onclick="previousQuestion()" id="prevQuestionBtn">‚Üê Previous</button>
                        <span id="questionCounter" style="margin: 0 10px;">Question 1 of 1</span>
                        <button onclick="nextQuestion()" id="nextQuestionBtn">Next ‚Üí</button>
                    </div>
                </div>

                <!-- Study Materials -->
                <div id="studyMaterials" style="display: none;">
                    <h4>Study Materials</h4>
                    <div id="materialsContent"></div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section" id="notesSection" style="display: none;">
            <h4>üìù Personal Notes</h4>
            <textarea class="notes-textarea" id="notesTextarea" placeholder="Take your personal notes here..."></textarea>
            <div style="margin-top: 10px;">
                <button onclick="saveNotes()">Save Notes</button>
                <button onclick="clearNotes()">Clear Notes</button>
            </div>
        </div>
    </div>

    <!-- Achievements -->
    <div class="achievements" id="achievements" style="display: none;">
        <h4>üèÜ Achievements</h4>
        <div id="achievementsList"></div>
    </div>

    <script>
        // Global variables
        let isReading = false;
        let currentUtterance = null;
        let isPaused = false;
        let sessionStartTime = Date.now();
        let currentCardIndex = 0;
        let currentQuestionIndex = 0;
        let flashcards = [];
        let quizQuestions = [];
        let sections = [];
        let currentSectionIndex = 0;
        let isFocusMode = false;
        let isReadingGuideActive = false;
        let achievements = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeVoices();
            loadProgress();
            updateSessionInfo();
            setInterval(updateSessionInfo, 1000);
            chunkContentIntoSections();
            updateProgress();
        });

        // Initialize speech synthesis voices
        function initializeVoices() {
            const voiceSelect = document.getElementById('voiceSelect');
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = function() {
                    const voices = speechSynthesis.getVoices();
                    voiceSelect.innerHTML = '<option value="">Select Voice</option>';
                    
                    // Add default options for common languages
                    const defaultOptions = [
                        { name: 'English (US)', lang: 'en-US' },
                        { name: 'English (UK)', lang: 'en-GB' },
                        { name: 'Spanish', lang: 'es-ES' },
                        { name: 'French', lang: 'fr-FR' },
                        { name: 'German', lang: 'de-DE' },
                        { name: 'Chinese', lang: 'zh-CN' },
                        { name: 'Japanese', lang: 'ja-JP' },
                        { name: 'Korean', lang: 'ko-KR' }
                    ];
                    
                    // Add default options first
                    defaultOptions.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.lang;
                        opt.textContent = option.name;
                        voiceSelect.appendChild(opt);
                    });
                    
                    // Add available browser voices
                    voices.forEach((voice, index) => {
                        const option = document.createElement('option');
                        option.value = `voice_${index}`;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        voiceSelect.appendChild(option);
                    });
                };
            }
        }

        // Focus Mode
        function toggleFocusMode() {
            const body = document.body;
            const btn = document.getElementById('focusBtn');
            
            if (isFocusMode) {
                body.classList.remove('focus-mode');
                btn.textContent = 'Focus Mode';
                isFocusMode = false;
                resetToDefaultStyles();
            } else {
                body.classList.add('focus-mode');
                btn.textContent = 'Exit Focus';
                isFocusMode = true;
                forceFocusModeStyles();
            }
        }

        function forceFocusModeStyles() {
            console.log('Applying focus mode styles...');
            
            // Force all text elements to be white
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('background-color', '#1a1a1a', 'important');
            });
            
            // Force all backgrounds to be dark
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#1a1a1a', 'important');
            });
            
            // Force MCQ options to be visible
            const optionElements = document.querySelectorAll('.mcq-option');
            optionElements.forEach(element => {
                element.style.setProperty('background-color', '#333333', 'important');
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('border-color', '#ffffff', 'important');
            });
            
            // Ensure header is visible in focus mode
            const header = document.querySelector('.header');
            if (header) {
                header.style.setProperty('display', 'block', 'important');
                header.style.setProperty('visibility', 'visible', 'important');
                header.style.setProperty('background-color', '#1a1a1a', 'important');
                header.style.setProperty('color', '#ffffff', 'important');
            }
            
            console.log('Focus mode styles applied');
        }

        // Reading Guide
        function toggleReadingGuide() {
            const guide = document.getElementById('readingGuide');
            const btn = document.getElementById('guideBtn');
            
            if (isReadingGuideActive) {
                guide.style.display = 'none';
                btn.textContent = 'Reading Guide';
                isReadingGuideActive = false;
            } else {
                guide.style.display = 'block';
                btn.textContent = 'Hide Guide';
                isReadingGuideActive = true;
                updateReadingGuidePosition();
            }
        }

        function updateReadingGuidePosition() {
            if (!isReadingGuideActive) return;
            
            const transcript = document.getElementById('transcriptContent');
            const guide = document.getElementById('readingGuide');
            const scrollTop = transcript.scrollTop;
            const scrollHeight = transcript.scrollHeight;
            const clientHeight = transcript.clientHeight;
            
            const progress = scrollTop / (scrollHeight - clientHeight);
            const position = 20 + (progress * 60); // 20% to 80% of viewport
            
            guide.style.top = position + '%';
        }

        // Enhanced Text-to-Speech
        function toggleReadAloud() {
            const button = document.getElementById('readAloudBtn');
            if (isReading) {
                stopReading();
                isReading = false;
                button.textContent = 'Read Aloud';
            } else {
                readTranscript();
                isReading = true;
                button.textContent = 'Stop Reading';
            }
        }

        function readTranscript() {
            if ('speechSynthesis' in window) {
                const transcript = document.getElementById('transcriptContent').textContent;
                const voiceSelect = document.getElementById('voiceSelect');
                const speedSelect = document.getElementById('speedSelect');
                
                currentUtterance = new SpeechSynthesisUtterance(transcript);
                currentUtterance.rate = parseFloat(speedSelect.value);
                currentUtterance.pitch = 1.0;
                
                if (voiceSelect.value !== '') {
                    if (voiceSelect.value.startsWith('voice_')) {
                        // Browser voice
                        const voices = speechSynthesis.getVoices();
                        const voiceIndex = parseInt(voiceSelect.value.replace('voice_', ''));
                        currentUtterance.voice = voices[voiceIndex];
                    } else {
                        // Language code
                        currentUtterance.lang = voiceSelect.value;
                    }
                }
                
                currentUtterance.onend = () => {
                    isReading = false;
                    document.getElementById('readAloudBtn').textContent = 'Read Aloud';
                };
                
                speechSynthesis.speak(currentUtterance);
                isReading = true;
            }
        }

        function stopReading() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                isReading = false;
                currentUtterance = null;
            }
        }

        function pauseReading() {
            if ('speechSynthesis' in window && isReading) {
                speechSynthesis.pause();
                isPaused = true;
            }
        }

        function resumeReading() {
            if ('speechSynthesis' in window && isPaused) {
                speechSynthesis.resume();
                isPaused = false;
            }
        }

        // Progress Tracking
        function updateProgress() {
            const transcript = document.getElementById('transcriptContent');
            const scrollTop = transcript.scrollTop;
            const scrollHeight = transcript.scrollHeight;
            const clientHeight = transcript.clientHeight;
            
            // Fix NaN issue by checking for valid values
            let progress = 0;
            if (scrollHeight > clientHeight && scrollHeight > 0) {
                progress = Math.min(100, Math.round((scrollTop / (scrollHeight - clientHeight)) * 100));
            } else if (scrollTop > 0) {
                progress = 100; // If content fits in view, mark as complete when scrolled
            }
            
            // Ensure progress is a valid number
            if (isNaN(progress) || progress < 0) {
                progress = 0;
            }
            
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = progress + '%';
            
            // Check for achievements
            checkAchievements(progress);
            
            // Save progress
            localStorage.setItem('learningProgress', progress);
        }

        function updateSessionInfo() {
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sessionTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress on each timer tick to ensure it's current
            updateProgress();
        }

        function resetProgress() {
            localStorage.removeItem('learningProgress');
            document.getElementById('transcriptContent').scrollTop = 0;
            updateProgress();
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem('learningProgress');
            if (savedProgress && !isNaN(parseInt(savedProgress))) {
                const transcript = document.getElementById('transcriptContent');
                const scrollHeight = transcript.scrollHeight;
                const clientHeight = transcript.clientHeight;
                
                // Only restore scroll position if content is scrollable
                if (scrollHeight > clientHeight) {
                    const targetScroll = (parseInt(savedProgress) / 100) * (scrollHeight - clientHeight);
                    transcript.scrollTop = targetScroll;
                }
            }
        }

        // Step Navigation
        function chunkContentIntoSections() {
            const content = document.getElementById('transcriptContent').textContent;
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentencesPerSection = Math.ceil(sentences.length / 5);
            
            sections = [];
            for (let i = 0; i < sentences.length; i += sentencesPerSection) {
                sections.push(sentences.slice(i, i + sentencesPerSection).join('. ') + '.');
            }
            
            document.getElementById('totalSections').textContent = sections.length;
            updateSectionDisplay();
        }

        function nextSection() {
            if (currentSectionIndex < sections.length - 1) {
                currentSectionIndex++;
                updateSectionDisplay();
            }
        }

        function previousSection() {
            if (currentSectionIndex > 0) {
                currentSectionIndex--;
                updateSectionDisplay();
            }
        }

        function updateSectionDisplay() {
            document.getElementById('currentSection').textContent = currentSectionIndex + 1;
            document.getElementById('transcriptContent').textContent = sections[currentSectionIndex];
            updateProgress();
        }

        // Visual Accessibility
        function changeTheme(theme) {
            // Clear all existing theme classes
            document.body.classList.remove('theme-yellow-black', 'theme-blue-white', 'theme-green-black', 'high-contrast');
            
            if (theme === 'high-contrast') {
                document.body.classList.add('high-contrast');
                forceHighContrastStyles();
            } else if (theme === 'yellow-black') {
                document.body.classList.add('theme-yellow-black');
                forceYellowBlackStyles();
            } else if (theme === 'blue-white') {
                document.body.classList.add('theme-blue-white');
                forceBlueWhiteStyles();
            } else if (theme === 'green-black') {
                document.body.classList.add('theme-green-black');
                forceGreenBlackStyles();
            } else if (theme === 'default') {
                // Reset to default - no special classes
                resetToDefaultStyles();
            }
        }

        function forceHighContrastStyles() {
            console.log('Applying forced high contrast styles...');
            
            // Force all text elements to be white
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('background-color', '#111111', 'important');
            });
            
            // Force all backgrounds to be dark
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#111111', 'important');
            });
            
            // Ensure header is visible
            const header = document.querySelector('.header');
            if (header) {
                header.style.setProperty('display', 'block', 'important');
                header.style.setProperty('visibility', 'visible', 'important');
                header.style.setProperty('background-color', '#111111', 'important');
                header.style.setProperty('color', '#ffffff', 'important');
            }
            
            console.log('High contrast styles applied');
        }

        function forceYellowBlackStyles() {
            console.log('Applying yellow-black theme styles...');
            
            // Force all text elements to be yellow
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#ffff00', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffff00', 'important');
                element.style.setProperty('background-color', '#000000', 'important');
            });
            
            // Force all backgrounds to be black
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#000000', 'important');
            });
            
            console.log('Yellow-black theme applied');
        }

        function forceBlueWhiteStyles() {
            console.log('Applying blue-white theme styles...');
            
            // Force all text elements to be white
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('background-color', '#000080', 'important');
            });
            
            // Force all backgrounds to be blue
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#000080', 'important');
            });
            
            console.log('Blue-white theme applied');
        }

        function forceGreenBlackStyles() {
            console.log('Applying green-black theme styles...');
            
            // Force all text elements to be green
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, label');
            textElements.forEach(element => {
                element.style.setProperty('color', '#00ff00', 'important');
            });
            
            // Force question text specifically
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#00ff00', 'important');
                element.style.setProperty('background-color', '#000000', 'important');
            });
            
            // Force all backgrounds to be black
            const backgroundElements = document.querySelectorAll('.transcript-section, .ai-section, .mcq-question, .enhanced-controls');
            backgroundElements.forEach(element => {
                element.style.setProperty('background-color', '#000000', 'important');
            });
            
            console.log('Green-black theme applied');
        }

        function resetToDefaultStyles() {
            console.log('Resetting to default styles...');
            
            // Remove all forced styles
            const allElements = document.querySelectorAll('*');
            allElements.forEach(element => {
                element.style.removeProperty('color');
                element.style.removeProperty('background-color');
            });
            
            console.log('Default styles restored');
        }

        function changeFontSize(size) {
            document.body.style.fontSize = size + 'px';
            document.getElementById('transcriptContent').style.fontSize = size + 'px';
        }

        function changeLineSpacing(spacing) {
            document.body.style.lineHeight = spacing;
            document.getElementById('transcriptContent').style.lineHeight = spacing;
        }

        function changeLetterSpacing(spacing) {
            document.body.style.letterSpacing = spacing;
            document.getElementById('transcriptContent').style.letterSpacing = spacing;
        }

        // Fullscreen Mode
        function fullscreenMode() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Notes System
        function toggleNotes() {
            const notesSection = document.getElementById('notesSection');
            const btn = document.getElementById('notesBtn');
            
            if (notesSection.style.display === 'none') {
                notesSection.style.display = 'block';
                btn.textContent = 'Hide Notes';
                loadNotes();
            } else {
                notesSection.style.display = 'none';
                btn.textContent = 'Show Notes';
            }
        }

        function saveNotes() {
            const notes = document.getElementById('notesTextarea').value;
            localStorage.setItem('userNotes', notes);
            alert('Notes saved!');
        }

        function loadNotes() {
            const savedNotes = localStorage.getItem('userNotes');
            if (savedNotes) {
                document.getElementById('notesTextarea').value = savedNotes;
            }
        }

        function clearNotes() {
            if (confirm('Are you sure you want to clear all notes?')) {
                document.getElementById('notesTextarea').value = '';
                localStorage.removeItem('userNotes');
            }
        }

        // Achievement System
        function checkAchievements(progress) {
            const newAchievements = [];
            
            if (progress >= 25 && !achievements.includes('quarter')) {
                newAchievements.push({ icon: 'üìñ', text: 'Quarter Complete - 25% read' });
                achievements.push('quarter');
            }
            
            if (progress >= 50 && !achievements.includes('halfway')) {
                newAchievements.push({ icon: 'üéØ', text: 'Halfway There - 50% complete' });
                achievements.push('halfway');
            }
            
            if (progress >= 75 && !achievements.includes('almost')) {
                newAchievements.push({ icon: 'üöÄ', text: 'Almost Done - 75% finished' });
                achievements.push('almost');
            }
            
            if (progress >= 100 && !achievements.includes('complete')) {
                newAchievements.push({ icon: 'üèÜ', text: 'Complete! - 100% finished' });
                achievements.push('complete');
            }
            
            if (newAchievements.length > 0) {
                showAchievements(newAchievements);
            }
        }

        function showAchievements(newAchievements) {
            const achievementsDiv = document.getElementById('achievements');
            const list = document.getElementById('achievementsList');
            
            newAchievements.forEach(achievement => {
                const div = document.createElement('div');
                div.className = 'achievement';
                div.innerHTML = `<span class="achievement-icon">${achievement.icon}</span>${achievement.text}`;
                list.appendChild(div);
            });
            
            achievementsDiv.style.display = 'block';
            
            setTimeout(() => {
                achievementsDiv.style.display = 'none';
            }, 5000);
        }

        // Translation Functions
        function translateToSpanish() {
            const transcript = document.getElementById('transcriptContent');
            const text = transcript.textContent;
            
            // Simple translation using browser's built-in capabilities
            const translations = {
                'The FOIL method': 'El m√©todo FOIL',
                'is a technique': 'es una t√©cnica',
                'used to multiply': 'utilizada para multiplicar',
                'two binomials': 'dos binomios',
                'FOIL stands for': 'FOIL significa',
                'First, Outer, Inner, Last': 'Primero, Exterior, Interior, √öltimo',
                'Let\'s break this down': 'Vamos a desglosar esto',
                'step by step': 'paso a paso',
                'When you have': 'Cuando tienes',
                'like': 'como',
                'you multiply them': 'los multiplicas',
                'using the FOIL method': 'usando el m√©todo FOIL',
                'Multiply the first terms': 'Multiplica los primeros t√©rminos',
                'Multiply the outer terms': 'Multiplica los t√©rminos exteriores',
                'Multiply the inner terms': 'Multiplica los t√©rminos interiores',
                'Multiply the last terms': 'Multiplica los √∫ltimos t√©rminos',
                'Then you add': 'Luego sumas',
                'all these products together': 'todos estos productos juntos',
                'Let\'s work through an example': 'Trabajemos con un ejemplo',
                'This method helps you remember': 'Este m√©todo te ayuda a recordar',
                'to multiply every term': 'multiplicar cada t√©rmino',
                'in the first binomial': 'en el primer binomio',
                'by every term': 'por cada t√©rmino',
                'in the second binomial': 'en el segundo binomio',
                'ensuring you don\'t miss': 'asegurando que no te pierdas',
                'any combinations': 'ninguna combinaci√≥n'
            };
            
            let translatedText = text;
            Object.keys(translations).forEach(english => {
                translatedText = translatedText.replace(new RegExp(english, 'gi'), translations[english]);
            });
            
            transcript.textContent = translatedText;
            document.getElementById('voiceSelect').value = 'es-ES';
        }

        function translateToFrench() {
            const transcript = document.getElementById('transcriptContent');
            const text = transcript.textContent;
            
            const translations = {
                'The FOIL method': 'La m√©thode FOIL',
                'is a technique': 'est une technique',
                'used to multiply': 'utilis√©e pour multiplier',
                'two binomials': 'deux bin√¥mes',
                'FOIL stands for': 'FOIL signifie',
                'First, Outer, Inner, Last': 'Premier, Ext√©rieur, Int√©rieur, Dernier',
                'Let\'s break this down': 'D√©composons cela',
                'step by step': '√©tape par √©tape',
                'When you have': 'Quand vous avez',
                'like': 'comme',
                'you multiply them': 'vous les multipliez',
                'using the FOIL method': 'en utilisant la m√©thode FOIL',
                'Multiply the first terms': 'Multipliez les premiers termes',
                'Multiply the outer terms': 'Multipliez les termes ext√©rieurs',
                'Multiply the inner terms': 'Multipliez les termes int√©rieurs',
                'Multiply the last terms': 'Multipliez les derniers termes',
                'Then you add': 'Ensuite vous ajoutez',
                'all these products together': 'tous ces produits ensemble',
                'Let\'s work through an example': 'Travaillons avec un exemple',
                'This method helps you remember': 'Cette m√©thode vous aide √† vous souvenir',
                'to multiply every term': 'de multiplier chaque terme',
                'in the first binomial': 'dans le premier bin√¥me',
                'by every term': 'par chaque terme',
                'in the second binomial': 'dans le deuxi√®me bin√¥me',
                'ensuring you don\'t miss': 'en s\'assurant que vous ne manquez',
                'any combinations': 'aucune combinaison'
            };
            
            let translatedText = text;
            Object.keys(translations).forEach(english => {
                translatedText = translatedText.replace(new RegExp(english, 'gi'), translations[english]);
            });
            
            transcript.textContent = translatedText;
            document.getElementById('voiceSelect').value = 'fr-FR';
        }

        function translateToGerman() {
            const transcript = document.getElementById('transcriptContent');
            const text = transcript.textContent;
            
            const translations = {
                'The FOIL method': 'Die FOIL-Methode',
                'is a technique': 'ist eine Technik',
                'used to multiply': 'die verwendet wird, um zu multiplizieren',
                'two binomials': 'zwei Binome',
                'FOIL stands for': 'FOIL steht f√ºr',
                'First, Outer, Inner, Last': 'Erste, √Ñu√üere, Innere, Letzte',
                'Let\'s break this down': 'Lass uns das aufschl√ºsseln',
                'step by step': 'Schritt f√ºr Schritt',
                'When you have': 'Wenn Sie haben',
                'like': 'wie',
                'you multiply them': 'multiplizieren Sie sie',
                'using the FOIL method': 'mit der FOIL-Methode',
                'Multiply the first terms': 'Multiplizieren Sie die ersten Terme',
                'Multiply the outer terms': 'Multiplizieren Sie die √§u√üeren Terme',
                'Multiply the inner terms': 'Multiplizieren Sie die inneren Terme',
                'Multiply the last terms': 'Multiplizieren Sie die letzten Terme',
                'Then you add': 'Dann addieren Sie',
                'all these products together': 'alle diese Produkte zusammen',
                'Let\'s work through an example': 'Lassen Sie uns ein Beispiel durchgehen',
                'This method helps you remember': 'Diese Methode hilft Ihnen, sich zu erinnern',
                'to multiply every term': 'jeden Term zu multiplizieren',
                'in the first binomial': 'im ersten Binom',
                'by every term': 'mit jedem Term',
                'in the second binomial': 'im zweiten Binom',
                'ensuring you don\'t miss': 'um sicherzustellen, dass Sie nicht verpassen',
                'any combinations': 'keine Kombinationen'
            };
            
            let translatedText = text;
            Object.keys(translations).forEach(english => {
                translatedText = translatedText.replace(new RegExp(english, 'gi'), translations[english]);
            });
            
            transcript.textContent = translatedText;
            document.getElementById('voiceSelect').value = 'de-DE';
        }

        function resetTranslation() {
            const transcript = document.getElementById('transcriptContent');
            transcript.textContent = `The FOIL method is a technique used to multiply two binomials. FOIL stands for First, Outer, Inner, Last. Let's break this down step by step.

When you have two binomials like (a + b) and (c + d), you multiply them using the FOIL method:

First: Multiply the first terms of each binomial (a √ó c)
Outer: Multiply the outer terms (a √ó d)
Inner: Multiply the inner terms (b √ó c)
Last: Multiply the last terms of each binomial (b √ó d)

Then you add all these products together: ac + ad + bc + bd

Let's work through an example: (x + 3)(x + 2)

First: x √ó x = x¬≤
Outer: x √ó 2 = 2x
Inner: 3 √ó x = 3x
Last: 3 √ó 2 = 6

Adding them together: x¬≤ + 2x + 3x + 6 = x¬≤ + 5x + 6

This method helps you remember to multiply every term in the first binomial by every term in the second binomial, ensuring you don't miss any combinations.`;
            document.getElementById('voiceSelect').value = 'en-US';
        }

        // AI Integration
        async function generateFlashcards() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                return;
            }

            const transcript = document.getElementById('transcriptContent').textContent;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'system',
                            content: 'Generate 5 educational flashcards based on the transcript. Return as JSON array with "front" and "back" properties. Make them clear and educational.'
                        }, {
                            role: 'user',
                            content: transcript
                        }],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    flashcards = JSON.parse(content);
                    displayFlashcards();
                } catch (e) {
                    // Fallback if JSON parsing fails
                    flashcards = [
                        { front: "What is FOIL?", back: "A method for multiplying binomials" },
                        { front: "What does FOIL stand for?", back: "First, Outer, Inner, Last" },
                        { front: "What do you multiply first in FOIL?", back: "The first terms of each binomial" },
                        { front: "What do you multiply last in FOIL?", back: "The last terms of each binomial" },
                        { front: "What do you do after multiplying all terms?", back: "Add all the products together" }
                    ];
                    displayFlashcards();
                }
            } catch (error) {
                console.error('Error generating flashcards:', error);
                alert('Error generating flashcards. Please check your API key and try again.');
            }
        }

        function displayFlashcards() {
            const container = document.getElementById('flashcardsContainer');
            const display = document.getElementById('flashcardDisplay');
            
            container.style.display = 'block';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('studyMaterials').style.display = 'none';
            
            currentCardIndex = 0;
            showCurrentCard();
        }

        function showCurrentCard() {
            if (flashcards.length === 0) return;
            
            const card = flashcards[currentCardIndex];
            const display = document.getElementById('flashcardDisplay');
            
            display.innerHTML = `
                <div class="flashcard" onclick="flipCard()">
                    <div id="cardFront">${card.front}</div>
                    <div id="cardBack" style="display: none;">${card.back}</div>
                </div>
            `;
            
            document.getElementById('cardCounter').textContent = `Card ${currentCardIndex + 1} of ${flashcards.length}`;
        }

        function flipCard() {
            const front = document.getElementById('cardFront');
            const back = document.getElementById('cardBack');
            const card = document.querySelector('.flashcard');
            
            if (front.style.display !== 'none') {
                front.style.display = 'none';
                back.style.display = 'block';
                card.classList.add('flipped');
            } else {
                front.style.display = 'block';
                back.style.display = 'none';
                card.classList.remove('flipped');
            }
        }

        function nextCard() {
            if (currentCardIndex < flashcards.length - 1) {
                currentCardIndex++;
                showCurrentCard();
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                showCurrentCard();
            }
        }

        async function generateQuiz() {
            const apiKey = document.getElementById('apiKey').value;
            
            if (!apiKey) {
                alert('Please enter your OpenAI API key to generate AI-powered questions.');
                return;
            }

            console.log('Generating AI-powered quiz...');
            
            // Show loading state
            const display = document.getElementById('quizDisplay');
            display.innerHTML = '<div style="text-align: center; padding: 20px;"><h4>Generating AI Questions...</h4><p>Please wait while AI creates personalized questions based on the transcript.</p></div>';
            
            const container = document.getElementById('quizContainer');
            container.style.display = 'block';
            document.getElementById('flashcardsContainer').style.display = 'none';
            document.getElementById('studyMaterials').style.display = 'none';

            const transcript = document.getElementById('transcriptContent').textContent;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'system',
                            content: 'You are an expert educator creating multiple choice questions. Generate exactly 5 questions based on the transcript. Return ONLY a valid JSON array with this exact format: [{"question": "Question text?", "options": ["Option A", "Option B", "Option C", "Option D"], "correct": 0, "explanation": "Explanation text"}]. Do not include any other text or formatting.'
                        }, {
                            role: 'user',
                            content: `Create 5 multiple choice questions about this content: ${transcript}`
                        }],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(`API Error: ${data.error?.message || 'Unknown error'}`);
                }
                
                const content = data.choices[0].message.content;
                console.log('AI Response:', content);
                
                // Try to extract JSON from the response
                let jsonMatch = content.match(/\[.*\]/s);
                if (!jsonMatch) {
                    throw new Error('No valid JSON found in response');
                }
                
                const parsedQuestions = JSON.parse(jsonMatch[0]);
                
                if (!Array.isArray(parsedQuestions) || parsedQuestions.length === 0) {
                    throw new Error('Invalid question format');
                }
                
                // Validate each question
                quizQuestions = parsedQuestions.filter(q => 
                    q.question && 
                    Array.isArray(q.options) && 
                    q.options.length === 4 && 
                    typeof q.correct === 'number' && 
                    q.explanation
                );
                
                if (quizQuestions.length === 0) {
                    throw new Error('No valid questions found');
                }
                
                console.log('AI Questions loaded:', quizQuestions.length, 'questions');
                currentQuestionIndex = 0;
                showCurrentQuestion();
                
            } catch (error) {
                console.error('Error generating AI quiz:', error);
                
                // Show error and fallback to hardcoded questions
                display.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
                        <h4>AI Generation Failed</h4>
                        <p>Error: ${error.message}</p>
                        <p>Using fallback questions instead.</p>
                        <button onclick="generateFallbackQuiz()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Load Fallback Questions
                        </button>
                    </div>
                `;
            }
        }

        function generateFallbackQuiz() {
            console.log('Generating fallback quiz...');
            
            quizQuestions = [
                {
                    question: "What does FOIL stand for?",
                    options: ["First, Outer, Inner, Last", "Fast, Organized, Intelligent, Learning", "Form, Order, Input, Logic", "Function, Output, Input, Logic"],
                    correct: 0,
                    explanation: "FOIL is an acronym for First, Outer, Inner, Last, which describes the order of multiplication in binomials."
                },
                {
                    question: "What do you multiply first in the FOIL method?",
                    options: ["The last terms", "The first terms", "The outer terms", "The inner terms"],
                    correct: 1,
                    explanation: "In FOIL, you start by multiplying the First terms of each binomial."
                },
                {
                    question: "What do you multiply last in the FOIL method?",
                    options: ["The first terms", "The outer terms", "The inner terms", "The last terms"],
                    correct: 3,
                    explanation: "In FOIL, you multiply the Last terms of each binomial last."
                },
                {
                    question: "What do you do after multiplying all terms in FOIL?",
                    options: ["Subtract them", "Add them together", "Divide them", "Multiply them again"],
                    correct: 1,
                    explanation: "After multiplying all terms using FOIL, you add all the products together."
                },
                {
                    question: "What is the result of (x + 3)(x + 2) using FOIL?",
                    options: ["x¬≤ + 5x + 6", "x¬≤ + 6x + 5", "x¬≤ + 2x + 3", "x¬≤ + 3x + 2"],
                    correct: 0,
                    explanation: "Using FOIL: First (x√óx=x¬≤), Outer (x√ó2=2x), Inner (3√óx=3x), Last (3√ó2=6). Adding: x¬≤ + 2x + 3x + 6 = x¬≤ + 5x + 6"
                }
            ];
            
            console.log('Fallback questions loaded:', quizQuestions.length, 'questions');
            currentQuestionIndex = 0;
            showCurrentQuestion();
        }

        function displayQuiz() {
            const container = document.getElementById('quizContainer');
            const display = document.getElementById('quizDisplay');
            
            container.style.display = 'block';
            document.getElementById('flashcardsContainer').style.display = 'none';
            document.getElementById('studyMaterials').style.display = 'none';
            
            currentQuestionIndex = 0;
            showCurrentQuestion();
        }

        function showCurrentQuestion() {
            if (quizQuestions.length === 0) return;
            
            const question = quizQuestions[currentQuestionIndex];
            const display = document.getElementById('quizDisplay');
            
            console.log('Showing question:', currentQuestionIndex + 1);
            console.log('Question:', question.question);
            console.log('Options:', question.options);
            
            const optionsHtml = question.options.map((option, index) => `
                <button class="mcq-option" onclick="selectAnswer(${index})" data-correct="${index === question.correct}">
                    ${option}
                </button>
            `).join('');
            
            display.innerHTML = `
                <div class="mcq-question">
                    <h5>${question.question}</h5>
                    ${optionsHtml}
                    <div id="feedback" class="mcq-feedback" style="display: none;"></div>
                </div>
            `;
            
            document.getElementById('questionCounter').textContent = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
        }

        function selectAnswer(selectedIndex) {
            const question = quizQuestions[currentQuestionIndex];
            const options = document.querySelectorAll('.mcq-option');
            const feedback = document.getElementById('feedback');
            
            options.forEach((option, index) => {
                option.disabled = true;
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && index !== question.correct) {
                    option.classList.add('incorrect');
                }
            });
            
            feedback.style.display = 'block';
            if (selectedIndex === question.correct) {
                feedback.textContent = 'Correct! ' + question.explanation;
                feedback.className = 'mcq-feedback correct';
            } else {
                feedback.textContent = 'Incorrect. ' + question.explanation;
                feedback.className = 'mcq-feedback incorrect';
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                showCurrentQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showCurrentQuestion();
            }
        }

        async function generateSummary() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                return;
            }

            const transcript = document.getElementById('transcriptContent').textContent;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'system',
                            content: 'Create a concise summary of the transcript, highlighting key points and main concepts.'
                        }, {
                            role: 'user',
                            content: transcript
                        }],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                const summary = data.choices[0].message.content;
                
                displayStudyMaterials('Summary', summary);
            } catch (error) {
                console.error('Error generating summary:', error);
                alert('Error generating summary. Please check your API key and try again.');
            }
        }

        async function generateStudyGuide() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                return;
            }

            const transcript = document.getElementById('transcriptContent').textContent;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'system',
                            content: 'Create a comprehensive study guide with step-by-step instructions, key concepts, and practice tips based on the transcript.'
                        }, {
                            role: 'user',
                            content: transcript
                        }],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                const studyGuide = data.choices[0].message.content;
                
                displayStudyMaterials('Study Guide', studyGuide);
            } catch (error) {
                console.error('Error generating study guide:', error);
                alert('Error generating study guide. Please check your API key and try again.');
            }
        }

        function displayStudyMaterials(title, content) {
            const container = document.getElementById('studyMaterials');
            const materialsContent = document.getElementById('materialsContent');
            
            container.style.display = 'block';
            document.getElementById('flashcardsContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            
            // Convert markdown to HTML
            let htmlContent = content
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')  // ### headings
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')   // ## headings  
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')    // # headings
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold**
                .replace(/\*(.*?)\*/g, '<em>$1</em>')     // *italic*
                .replace(/\n\n/g, '</p><p>')              // Paragraphs
                .replace(/\n/g, '<br>');                  // Line breaks
            
            // Wrap in paragraph tags if not already wrapped
            if (!htmlContent.startsWith('<h') && !htmlContent.startsWith('<p')) {
                htmlContent = '<p>' + htmlContent + '</p>';
            }
            
            materialsContent.innerHTML = `
                <h4>${title}</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                    ${htmlContent}
                </div>
            `;
        }

        // Event listeners
        document.getElementById('transcriptContent').addEventListener('scroll', function() {
            updateProgress();
            updateReadingGuidePosition();
        });

        // Initialize achievements
        achievements = JSON.parse(localStorage.getItem('achievements') || '[]');

        // Test function to force display options
        function testMCQDisplay() {
            console.log('Testing MCQ display...');
            const display = document.getElementById('quizDisplay');
            if (display) {
                display.innerHTML = `
                    <div class="mcq-question">
                        <h5>Test Question: What does FOIL stand for?</h5>
                        <button class="mcq-option" onclick="alert('Option A clicked')">First, Outer, Inner, Last</button>
                        <button class="mcq-option" onclick="alert('Option B clicked')">Fast, Organized, Intelligent, Learning</button>
                        <button class="mcq-option" onclick="alert('Option C clicked')">Form, Order, Input, Logic</button>
                        <button class="mcq-option" onclick="alert('Option D clicked')">Function, Output, Input, Logic</button>
                    </div>
                `;
                console.log('Test MCQ displayed');
            } else {
                console.log('Quiz display element not found');
            }
        }

        // Force apply high contrast styles
        function forceHighContrast() {
            console.log('Forcing high contrast styles...');
            changeTheme('high-contrast');
        }

        // Test function to manually fix question visibility
        function fixQuestionVisibility() {
            console.log('Manually fixing question visibility...');
            
            const questionElements = document.querySelectorAll('.mcq-question, .mcq-question h5, .mcq-question p, .mcq-question div, .mcq-question span');
            questionElements.forEach(element => {
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('background-color', '#111111', 'important');
                element.style.setProperty('font-weight', 'bold', 'important');
            });
            
            console.log('Question visibility fixed');
        }

        // Force display quiz container and test options
        function forceQuizDisplay() {
            console.log('Forcing quiz display...');
            
            // Show quiz container
            const container = document.getElementById('quizContainer');
            container.style.display = 'block';
            
            // Hide other containers
            document.getElementById('flashcardsContainer').style.display = 'none';
            document.getElementById('studyMaterials').style.display = 'none';
            
            // Force display test options
            const display = document.getElementById('quizDisplay');
            display.innerHTML = `
                <div class="mcq-question">
                    <h5>FORCED TEST: What does FOIL stand for?</h5>
                    <button class="mcq-option" style="display: block; width: 100%; margin: 10px 0; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="alert('A clicked')">
                        A) First, Outer, Inner, Last
                    </button>
                    <button class="mcq-option" style="display: block; width: 100%; margin: 10px 0; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="alert('B clicked')">
                        B) Fast, Organized, Intelligent, Learning
                    </button>
                    <button class="mcq-option" style="display: block; width: 100%; margin: 10px 0; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="alert('C clicked')">
                        C) Form, Order, Input, Logic
                    </button>
                    <button class="mcq-option" style="display: block; width: 100%; margin: 10px 0; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="alert('D clicked')">
                        D) Function, Output, Input, Logic
                    </button>
                </div>
            `;
            
            console.log('Forced quiz display completed');
        }
    </script>
</body>
</html> 